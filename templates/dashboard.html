{% extends "base.html" %}
{% block title %}Dashboard - Reunited{% endblock %}

<!-- Adding Bootstrap Icons CSS for icon display -->
{% block head %}
<link href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.0/font/bootstrap-icons.css" rel="stylesheet">
{% endblock %}

{% block content %}
<div class="container-fluid">
  <div class="dashboard-header mb-4">
    <h1 class="fw-bold mb-2">Dashboard</h1>
    <p class="mb-0 opacity-75">Welcome to Reunited, {{ session.first_name }}!</p>
  </div>

  <!-- Stats Cards -->
  <div class="row g-4 mb-4">
    <!-- Items Posted -->
    <div class="col-12 col-md-6 col-xl-3">
      <div class="stats-card">
        <div class="stats-icon">
          <i class="bi bi-plus-circle text-info"></i>
        </div>
        <h2 class="stats-number text-info">{{ stats.total_posted }}</h2>
        <p class="mb-0 opacity-75">Items Posted</p>
      </div>
    </div>
    
    <!-- Items Found/Claimed -->
    <div class="col-12 col-md-6 col-xl-3">
      <div class="stats-card">
        <div class="stats-icon">
          <i class="bi bi-check-circle text-success"></i>
        </div>
        <h2 class="stats-number text-success">{{ stats.total_claimed }}</h2>
        <p class="mb-0 opacity-75">Items Claimed</p>
      </div>
    </div>
    
    <!-- Total Activity/Matches -->
    <div class="col-12 col-md-6 col-xl-3">
      <div class="stats-card">
        <div class="stats-icon">
          <i class="bi bi-puzzle" style="color: #9b59b6;"></i>
        </div>
        <h2 class="stats-number" style="color: #9b59b6;">{{ stats.total_activity }}</h2>
        <p class="mb-0 opacity-75">Potential Matches</p>
      </div>
    </div>
    
    <!-- Returned Items -->
    <div class="col-12 col-md-6 col-xl-3">
      <div class="stats-card">
        <div class="stats-icon">
          <i class="bi bi-arrow-return-left text-danger"></i>
        </div>
        <h2 class="stats-number text-danger">{{ stats.total_returned }}</h2>
        <p class="mb-0 opacity-75">Items Returned</p>
      </div>
    </div>
  </div>

  <!-- Quick Actions -->
  <div class="row g-4 mb-4">
    <!-- Report Lost Item -->
    <div class="col-12 col-lg-4">
      <div class="stats-card text-center">
        <div class="stats-icon mx-auto">
          <i class="bi bi-plus-circle text-info"></i>
        </div>
        <h4 class="mb-3">Report Lost Item</h4>
        <p class="mb-4 opacity-75">Lost something? Create a detailed report to help others find and return it.</p>
        <button class="btn btn-primary-custom" data-bs-toggle="modal" data-bs-target="#lostItemModal">
          <i class="bi bi-plus-circle me-2"></i>Report Lost Item
        </button>
      </div>
    </div>

    <!-- Report Found Item -->
    <div class="col-12 col-lg-4">
      <div class="stats-card text-center">
        <div class="stats-icon mx-auto">
          <i class="bi bi-search text-success"></i>
        </div>
        <h4 class="mb-3">Report Found Item</h4>
        <p class="mb-4 opacity-75">Found something? Help reunite it with its owner by reporting it here.</p>
        <button class="btn btn-primary-custom" data-bs-toggle="modal" data-bs-target="#foundItemModal">
          <i class="bi bi-search me-2"></i>Report Found Item
        </button>
      </div>
    </div>

    <!-- Share Feedback -->
    <div class="col-12 col-lg-4">
      <div class="stats-card text-center">
        <div class="stats-icon mx-auto">
          <i class="bi bi-chat-heart text-warning"></i>
        </div>
        <h4 class="mb-3">Share Feedback</h4>
        <p class="mb-4 opacity-75">Help us improve Reunited by sharing your experience and suggestions.</p>
        <button class="btn btn-primary-custom" data-bs-toggle="modal" data-bs-target="#feedbackModal">
          <i class="bi bi-chat-heart me-2"></i>Share Feedback
        </button>
      </div>
    </div>
  </div>

  <!-- Community Feedback -->
  {% if recent_feedback %}
  <div class="row mb-5">
    <div class="col-12">
      <div class="stats-card">
        <div class="d-flex justify-content-between align-items-center mb-4">
          <h4 class="mb-0">
            <i class="bi bi-chat-heart me-2"></i>Community Feedback
          </h4>
        </div>
        
        <div class="feedback-carousel-wrapper">
          <button class="carousel-control carousel-control-prev" onclick="previousFeedback()" id="prevBtn">
            <i class="bi bi-chevron-left"></i>
          </button>
          
          <button class="carousel-control carousel-control-next" onclick="nextFeedback()" id="nextBtn">
            <i class="bi bi-chevron-right"></i>
          </button>
          
          <div class="feedback-carousel-container">
            <div class="feedback-carousel" id="feedbackCarousel">
              {% for feedback in recent_feedback %}
              <div class="feedback-slide">
                <div class="feedback-card clickable-feedback" 
                     data-feedback-id="{{ feedback.id }}"
                     data-user-name="{{ feedback.first_name }} {{ feedback.last_name }}"
                     data-profile-picture="{% if feedback.profile_picture %}{{ url_for('uploaded_file', filename=feedback.profile_picture) }}{% endif %}"
                     data-rating="{{ feedback.rating }}"
                     data-message="{{ feedback.message }}"
                     data-date="{{ feedback.created_at.strftime('%b %d, %Y') }}">
                  <div class="feedback-header">
                    <div class="profile-picture">
                      {% if feedback.profile_picture %}
                        <img src="{{ url_for('uploaded_file', filename=feedback.profile_picture) }}" 
                             alt="{{ feedback.first_name }} {{ feedback.last_name }}" 
                             class="profile-img">
                      {% else %}
                        <div class="profile-placeholder">
                          <i class="bi bi-person-fill"></i>
                        </div>
                      {% endif %}
                    </div>
                    <div class="feedback-info">
                      <h6 class="user-name">{{ feedback.first_name }} {{ feedback.last_name }}</h6>
                      {% if feedback.rating %}
                      <div class="rating-display">
                        {% for i in range(feedback.rating) %}
                          <i class="bi bi-star-fill"></i>
                        {% endfor %}
                        {% for i in range(5 - feedback.rating) %}
                          <i class="bi bi-star"></i>
                        {% endfor %}
                      </div>
                      {% endif %}
                    </div>
                  </div>
                  <p class="feedback-message">{{ feedback.message }}</p>
                  <small class="feedback-date">{{ feedback.created_at.strftime('%b %d, %Y') }}</small>
                </div>
              </div>
              {% endfor %}
            </div>
          </div>
        </div>
      </div>
    </div>
  </div>
  {% endif %}

    <!-- Recent Activity -->
  {% if recent_items %}
  <div class="row mb-4">
    <div class="col-12">
      <div class="stats-card">
        <h4 class="mb-4">
          <i class="bi bi-clock-history me-2"></i>Recent Activity
        </h4>
        <div class="row g-3">
          {% for item in recent_items %}
          <div class="col-12 col-md-6 col-lg-4">
            <div class="card border-0 shadow-sm clickable-item" 
                 data-item-id="{{ item.id }}"
                 data-item-type="{{ item.type }}"
                 style="cursor: pointer;"
                 onclick="redirectToItemPage('{{ item.type }}', '{{ item.id }}')">
              {% if item.image_path %}
              <img src="{{ url_for('static', filename='uploads/items/' + item.image_path.split('/')[-1]) }}" 
                   class="card-img-top" style="height: 150px; object-fit: cover;">
              {% else %}
              <div class="card-img-top bg-light d-flex align-items-center justify-content-center" 
                   style="height: 150px;">
                <i class="bi bi-image fs-1 text-muted"></i>
              </div>
              {% endif %}
              <div class="card-body">
                <h6 class="card-title mb-2">{{ item.title }}</h6>
                <div class="d-flex justify-content-between align-items-center">
                  <span class="badge {% if item.type == 'lost' %}bg-info{% else %}bg-success{% endif %}">
                    {{ item.type.title() }}
                  </span>
                  <small class="text-muted">{{ item.created_at.strftime('%b %d') }}</small>
                </div>
              </div>
            </div>
          </div>
          {% endfor %}
        </div>
      </div>
    </div>
  </div>
  {% endif %}
</div>

<!-- Feedback Detail Modal -->
<div class="modal fade" id="feedbackDetailModal" tabindex="-1" aria-labelledby="feedbackDetailModalLabel" aria-hidden="true">
  <div class="modal-dialog modal-lg">
    <div class="modal-content">
      <div class="modal-header">
        <div class="d-flex align-items-center">
          <div class="modal-profile-picture me-3" id="modalProfilePicture">
            <!-- Profile picture will be inserted here -->
          </div>
          <div>
            <h5 class="modal-title fw-bold mb-1" id="modalUserName">User Name</h5>
            <div class="rating-display" id="modalRating">
              <!-- Rating stars will be inserted here -->
            </div>
          </div>
        </div>
        <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
      </div>
      <div class="modal-body">
        <p class="feedback-full-message mb-3" id="modalFullMessage"></p>
        <small class="text-muted" id="modalDate"></small>
      </div>
      <div class="modal-footer">
        <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Close</button>
      </div>
    </div>
  </div>
</div>

<!-- Item Detail Modal -->
<div class="modal fade" id="itemDetailModal" tabindex="-1" aria-labelledby="itemDetailModalLabel" aria-hidden="true">
  <div class="modal-dialog modal-lg">
    <div class="modal-content">
      <div class="modal-header">
        <h5 class="modal-title fw-bold" id="modalItemTitle">Item Title</h5>
        <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
      </div>
      <div class="modal-body">
        <div class="row">
          <!-- Item Image -->
          <div class="col-12 col-md-6 mb-3">
            <div class="item-image-container text-center" id="modalImageContainer">
              <!-- Image or placeholder will be inserted here -->
            </div>
          </div>
          
          <!-- Item Details -->
          <div class="col-12 col-md-6">
            <div class="item-details">
              <div class="mb-3">
                <span class="badge fs-6" id="modalItemType">Type</span>
              </div>
              
              <div class="mb-3">
                <strong>Category:</strong>
                <span id="modalItemCategory" class="ms-2">Category</span>
              </div>
              
              <div class="mb-3">
                <strong>Location:</strong>
                <span id="modalItemLocation" class="ms-2">Location</span>
              </div>
              
              <div class="mb-3">
                <strong>Date:</strong>
                <span id="modalItemDate" class="ms-2">Date</span>
              </div>
              
              <div class="mb-3" id="modalRewardSection" style="display: none;">
                <strong>Reward:</strong>
                <span id="modalItemReward" class="ms-2 text-success fw-bold">Reward</span>
              </div>
            </div>
          </div>
        </div>
        
        <!-- Description -->
        <div class="row mt-3">
          <div class="col-12">
            <div class="description-section">
              <h6 class="fw-bold mb-2">Description:</h6>
              <p id="modalItemDescription" class="text-muted">Description will appear here...</p>
            </div>
          </div>
        </div>
      </div>
      <div class="modal-footer">
        <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Close</button>
      </div>
    </div>
  </div>
</div>

<!-- Feedback Modal -->
<div class="modal fade" id="feedbackModal" tabindex="-1" aria-labelledby="feedbackModalLabel" aria-hidden="true">
  <div class="modal-dialog modal-lg">
    <div class="modal-content">
      <form action="{{ url_for('submit_feedback') }}" method="POST">
        <div class="modal-header">
          <h5 class="modal-title fw-bold" id="feedbackModalLabel">Share Your Feedback</h5>
          <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
        </div>
        <div class="modal-body">
          <div class="mb-3">
            <label class="form-label">Your Experience</label>
            <textarea name="message" class="form-control" rows="4" 
                      placeholder="Tell us about your experience with Reunited..." required></textarea>
          </div>
          <div class="mb-3">
            <label class="form-label">Rating (Optional)</label>
            <div class="rating-stars">
              <input type="radio" name="rating" value="1" id="star1">
              <label for="star1" class="star">
                <i class="bi bi-star-fill"></i>
              </label>
              <input type="radio" name="rating" value="2" id="star2">
              <label for="star2" class="star">
                <i class="bi bi-star-fill"></i>
              </label>
              <input type="radio" name="rating" value="3" id="star3">
              <label for="star3" class="star">
                <i class="bi bi-star-fill"></i>
              </label>
              <input type="radio" name="rating" value="4" id="star4">
              <label for="star4" class="star">
                <i class="bi bi-star-fill"></i>
              </label>
              <input type="radio" name="rating" value="5" id="star5">
              <label for="star5" class="star">
                <i class="bi bi-star-fill"></i>
              </label>
            </div>
          </div>
          <div class="mb-3">
            <div class="form-check">
              <input class="form-check-input" type="checkbox" name="is_public" value="1" id="publicFeedback" checked>
              <label class="form-check-label" for="publicFeedback">
                Make this feedback public (visible to other users)
              </label>
            </div>
          </div>
        </div>
        <div class="modal-footer">
          <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
          <button type="submit" class="btn-primary-custom">Submit Feedback</button>
        </div>
      </form>
    </div>
  </div>
</div>

<!-- Lost Item Modal -->
<div class="modal fade" id="lostItemModal" tabindex="-1" aria-labelledby="lostItemModalLabel" aria-hidden="true">
  <div class="modal-dialog modal-lg">
    <div class="modal-content">
      <form action="{{ url_for('lost') }}" method="POST" enctype="multipart/form-data" id="lostItemForm">
        <div class="modal-header">
          <h5 class="modal-title fw-bold" id="lostItemModalLabel">Report Lost Item</h5>
          <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
        </div>
        <div class="modal-body">
          <!-- Flash Data Extraction -->
          {% with messages = get_flashed_messages(with_categories=true) %}
          {% for category, message in messages %}
            {% if 'LOST_FORM_DATA:' in message %}
              <script>
                // Extract form data from flash message and store in sessionStorage for LOST items
                const lostMessageText = "{{ message }}";
                console.log('Lost flash message:', lostMessageText);
                if (lostMessageText.includes('LOST_FORM_DATA:')) {
                  const formDataJson = lostMessageText.split('LOST_FORM_DATA:')[1];
                  console.log('Lost form data JSON:', formDataJson);
                  try {
                    // Decode HTML entities before parsing JSON
                    const decodedJson = formDataJson.replace(/&#34;/g, '"');
                    console.log('Decoded JSON:', decodedJson);
                    const formData = JSON.parse(decodedJson);
                    sessionStorage.setItem('lostFormData', JSON.stringify(formData));
                    console.log('✅ Lost form data stored in sessionStorage');
                  } catch (e) {
                    console.error('Error parsing lost form data:', e);
                  }
                }
              </script>
            {% endif %}
          {% endfor %}
          {% endwith %}

          <!-- Error Message Display -->
          {% with messages = get_flashed_messages(with_categories=true) %}
            {% for category, message in messages %}
              {% if category == 'danger' and 'LOST_FORM_DATA:' in message %}
                <div class="alert alert-danger alert-dismissible fade show" role="alert">
                  <i class="bi bi-exclamation-triangle-fill me-2"></i>
                  {{ message.split('LOST_FORM_DATA:')[0].strip() }}
                  <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
                </div>
              {% endif %}
            {% endfor %}
          {% endwith %}

          <div class="mb-3">
            <label class="form-label">Item Title</label>
            <input type="text" name="title" class="form-control" required>
          </div>
          <div class="mb-3">
            <label class="form-label">Category</label>
            <select name="category" class="form-select" required>
              <option value="">Select category</option>
              <option value="Electronics">Electronics</option>
              <option value="Wallet">Wallet</option>
              <option value="Keys">Keys</option>
              <option value="Phone">Phone</option>
              <option value="Laptop/Tablet">Laptop/Tablet</option>
              <option value="Bag/Backpack">Bag/Backpack</option>
              <option value="Clothing">Clothing</option>
              <option value="Jewelry">Jewelry</option>
              <option value="Documents">Documents</option>
              <option value="Books">Books</option>
              <option value="Glasses">Glasses</option>
              <option value="Sports Equipment">Sports Equipment</option>
              <option value="Pet Items">Pet Items</option>
              <option value="Other">Other</option>
            </select>
          </div>
          <div class="mb-3">
            <label class="form-label">Description</label>
            <textarea name="description" class="form-control" rows="3" required></textarea>
          </div>
          <div class="mb-3">
            <label class="form-label">Location Lost</label>
            <input type="text" name="location_reported" class="form-control" required>
          </div>
          <div class="mb-3">
            <label class="form-label">Reward (Optional)</label>
            <input type="text" name="reward" class="form-control">
          </div>
          <div class="mb-3">
            <label class="form-label">Upload Item Image (Optional)</label>
            <input type="file" name="image" class="form-control" accept="image/*" id="lostItemImage">
            <!-- Lost Item Modal - Camera Section -->
            <div class="mb-3">
                <label class="form-label">Or Take a Photo (Optional)</label>
                <div class="camera-section">
                    <!-- Camera Preview -->
                    <div class="camera-preview mb-2 text-center" id="lostCameraPreview" style="display: none;">
                        <video id="lostVideo" autoplay playsinline style="max-width: 100%; max-height: 300px; border-radius: 8px;"></video>
                        <canvas id="lostCanvas" style="display: none;"></canvas>
                    </div>
                    
                    <!-- Camera Controls -->
                    <div class="camera-controls text-center">
                        <button type="button" class="btn btn-outline-primary btn-sm me-2" id="lostStartCamera">
                            <i class="bi bi-camera-video me-1"></i>Start Camera
                        </button>
                        <button type="button" class="btn btn-success btn-sm me-2" id="lostCapturePhoto" style="display: none;">
                            <i class="bi bi-camera me-1"></i>Capture Photo
                        </button>
                        <button type="button" class="btn btn-warning btn-sm" id="lostRetakePhoto" style="display: none;">
                            <i class="bi bi-arrow-repeat me-1"></i>Retake
                        </button>
                        <button type="button" class="btn btn-secondary btn-sm" id="lostStopCamera" style="display: none;">
                            <i class="bi bi-x-circle me-1"></i>Stop Camera
                        </button>
                    </div>
                    
                    <!-- Captured Image Preview -->
                    <div class="captured-preview mt-2 text-center" id="lostCapturedPreview" style="display: none;">
                        <p class="small text-muted mb-2">Captured Photo:</p>
                        <img id="lostCapturedImage" src="" style="max-width: 200px; border-radius: 8px; border: 2px solid #007bff;">
                        <input type="hidden" name="captured_image" id="lostCapturedImageData">
                    </div>
                </div>
            </div>
            <div class="form-text">
              <small class="text-muted">
                <i class="bi bi-info-circle me-1"></i>
                Please upload only images of the item itself. <strong>Images containing human faces will be automatically rejected</strong> for privacy reasons.
              </small>
            </div>
            <!-- Face Detection Warning -->
            <div class="alert alert-warning mt-2 py-2" id="lostFaceWarning" style="display: none;">
              <i class="bi bi-exclamation-triangle me-2"></i>
              <small>Please ensure your image shows only the item. Photos with people cannot be accepted.</small>
            </div>
          </div>
          
          <!-- Terms and Conditions Section -->
          <div class="mb-3">
            <label class="form-label fw-semibold">Terms and Conditions</label>
            <div class="border rounded p-3 bg-light" style="max-height: 200px; overflow-y: auto;">
              <h6 class="fw-bold">Data Privacy Policy & User Agreement</h6>
              
              <p><strong>1. Image Guidelines</strong></p>
              <ul class="small">
                <li>Upload only images of the actual item itself</li>
                <li><strong>Images containing human faces will be automatically rejected</strong></li>
                <li>Do not include pictures of people, faces, or personal identification</li>
                <li>Ensure images are clear and focused on the item</li>
              </ul>

              <p><strong>2. Data Privacy</strong></p>
              <ul class="small">
                <li>We collect only necessary information for item matching</li>
                <li>Your contact information is shared only with potential matches</li>
                <li>We do not sell or share your data with third parties</li>
                <li>You can request data deletion at any time</li>
              </ul>

              <p><strong>3. User Responsibilities</strong></p>
              <ul class="small">
                <li>Provide accurate and truthful information in all reports</li>
                <li>Verify ownership before returning items</li>
                <li>Respect other users' privacy and contact information</li>
                <li>Report suspicious activity to administrators</li>
              </ul>

              <p><strong>4. Platform Usage</strong></p>
              <ul class="small">
                <li>Use Reunited only for its intended purpose</li>
                <li>Do not post false or misleading information</li>
                <li>Be respectful in all communications</li>
                <li>Follow campus policies and procedures</li>
              </ul>

              <div class="alert alert-warning small mt-2 mb-0">
                <i class="bi bi-exclamation-triangle me-1"></i>
                <strong>Important:</strong> By checking the agreement box below, you confirm that you have read, understood, and agree to all terms and conditions stated above.
              </div>
            </div>
            
            <div class="form-check mt-3">
              <input class="form-check-input" type="checkbox" name="terms_agreed" id="lostTermsAgreed" required>
              <label class="form-check-label fw-semibold" for="lostTermsAgreed">
                I have read and agree to the Terms and Conditions and Data Privacy Policy
              </label>
            </div>
          </div>
        </div>
        <div class="modal-footer">
          <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
          <button type="submit" class="btn btn-primary" id="lostSubmitBtn">Submit Lost Item</button>
        </div>
      </form>
    </div>
  </div>
</div>

<!-- Found Item Modal -->
<div class="modal fade" id="foundItemModal" tabindex="-1" aria-labelledby="foundItemModalLabel" aria-hidden="true">
  <div class="modal-dialog modal-lg">
    <div class="modal-content">
      <form action="{{ url_for('found') }}" method="POST" enctype="multipart/form-data" id="foundItemForm">
        <div class="modal-header">
          <h5 class="modal-title fw-bold" id="foundItemModalLabel">Report Found Item</h5>
          <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
        </div>
        <div class="modal-body">
          <!-- Flash Data Extraction -->
          {% with messages = get_flashed_messages(with_categories=true) %}
          {% for category, message in messages %}
            {% if 'FOUND_FORM_DATA:' in message %}
              <script>
                // Extract form data from flash message and store in sessionStorage for FOUND items
                const foundMessageText = "{{ message }}";
                console.log('Found flash message:', foundMessageText);
                if (foundMessageText.includes('FOUND_FORM_DATA:')) {
                  const formDataJson = foundMessageText.split('FOUND_FORM_DATA:')[1];
                  console.log('Found form data JSON:', formDataJson);
                  try {
                    // Decode HTML entities before parsing JSON
                    const decodedJson = formDataJson.replace(/&#34;/g, '"');
                    console.log('Decoded JSON:', decodedJson);
                    const formData = JSON.parse(decodedJson);
                    sessionStorage.setItem('foundFormData', JSON.stringify(formData));
                    console.log('✅ Found form data stored in sessionStorage');
                  } catch (e) {
                    console.error('Error parsing found form data:', e);
                  }
                }
              </script>
            {% endif %}
          {% endfor %}
          {% endwith %}

          <!-- Error Message Display -->
          {% with messages = get_flashed_messages(with_categories=true) %}
            {% for category, message in messages %}
              {% if category == 'danger' and 'FOUND_FORM_DATA:' in message %}
                <div class="alert alert-danger alert-dismissible fade show" role="alert">
                  <i class="bi bi-exclamation-triangle-fill me-2"></i>
                  {{ message.split('FOUND_FORM_DATA:')[0].strip() }}
                  <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
                </div>
              {% endif %}
            {% endfor %}
          {% endwith %}

          <div class="mb-3">
            <label class="form-label">Item Title</label>
            <input type="text" name="title" class="form-control" required>
          </div>
          <div class="mb-3">
            <label class="form-label">Category</label>
            <select name="category" class="form-select" required>
              <option value="">Select category</option>
              <option value="Electronics">Electronics</option>
              <option value="Wallet">Wallet</option>
              <option value="Keys">Keys</option>
              <option value="Phone">Phone</option>
              <option value="Laptop/Tablet">Laptop/Tablet</option>
              <option value="Bag/Backpack">Bag/Backpack</option>
              <option value="Clothing">Clothing</option>
              <option value="Jewelry">Jewelry</option>
              <option value="Documents">Documents</option>
              <option value="Books">Books</option>
              <option value="Glasses">Glasses</option>
              <option value="Sports Equipment">Sports Equipment</option>
              <option value="Pet Items">Pet Items</option>
              <option value="Other">Other</option>
            </select>
          </div>
          <div class="mb-3">
            <label class="form-label">Description</label>
            <textarea name="description" class="form-control" rows="3" required></textarea>
          </div>
          <div class="mb-3">
            <label class="form-label">Location Found</label>
            <input type="text" name="location_reported" class="form-control" required>
          </div>
          <div class="mb-3">
            <label class="form-label">Upload Item Image <span class="text-danger">*</span></label>
            <input type="file" name="image" class="form-control" accept="image/*" id="foundItemImage">
            <!-- Found Item Modal - Camera Section -->
            <div class="mb-3">
                <label class="form-label">Or Take a Photo <span class="text-danger">*</span></label>
                <div class="camera-section">
                    <!-- Camera Preview -->
                    <div class="camera-preview mb-2 text-center" id="foundCameraPreview" style="display: none;">
                        <video id="foundVideo" autoplay playsinline style="max-width: 100%; max-height: 300px; border-radius: 8px;"></video>
                        <canvas id="foundCanvas" style="display: none;"></canvas>
                    </div>
                    
                    <!-- Camera Controls -->
                    <div class="camera-controls text-center">
                        <button type="button" class="btn btn-outline-primary btn-sm me-2" id="foundStartCamera">
                            <i class="bi bi-camera-video me-1"></i>Start Camera
                        </button>
                        <button type="button" class="btn btn-success btn-sm me-2" id="foundCapturePhoto" style="display: none;">
                            <i class="bi bi-camera me-1"></i>Capture Photo
                        </button>
                        <button type="button" class="btn btn-warning btn-sm" id="foundRetakePhoto" style="display: none;">
                            <i class="bi bi-arrow-repeat me-1"></i>Retake
                        </button>
                        <button type="button" class="btn btn-secondary btn-sm" id="foundStopCamera" style="display: none;">
                            <i class="bi bi-x-circle me-1"></i>Stop Camera
                        </button>
                    </div>
                    
                    <!-- Captured Image Preview -->
                    <div class="captured-preview mt-2 text-center" id="foundCapturedPreview" style="display: none;">
                        <p class="small text-muted mb-2">Captured Photo:</p>
                        <img id="foundCapturedImage" src="" style="max-width: 200px; border-radius: 8px; border: 2px solid #007bff;">
                        <input type="hidden" name="captured_image" id="foundCapturedImageData">
                    </div>
                </div>
            </div>
            <div class="form-text">
              <small class="text-muted">
                <i class="bi bi-info-circle me-1"></i>
                Please upload only images of the item itself. <strong>Images containing human faces will be automatically rejected</strong> for privacy reasons.
              </small>
            </div>
            <!-- Face Detection Warning -->
            <div class="alert alert-warning mt-2 py-2" id="foundFaceWarning" style="display: none;">
              <i class="bi bi-exclamation-triangle me-2"></i>
              <small>Please ensure your image shows only the item. Photos with people cannot be accepted.</small>
            </div>
          </div>
          
          <!-- Terms and Conditions Section -->
          <div class="mb-3">
            <label class="form-label fw-semibold">Terms and Conditions</label>
            <div class="border rounded p-3 bg-light" style="max-height: 200px; overflow-y: auto;">
              <h6 class="fw-bold">Data Privacy Policy & User Agreement</h6>
              
              <p><strong>1. Image Guidelines</strong></p>
              <ul class="small">
                <li>Upload only images of the actual item itself</li>
                <li><strong>Images containing human faces will be automatically rejected</strong></li>
                <li>Do not include pictures of people, faces, or personal identification</li>
                <li>Ensure images are clear and focused on the item</li>
              </ul>

              <p><strong>2. Data Privacy</strong></p>
              <ul class="small">
                <li>We collect only necessary information for item matching</li>
                <li>Your contact information is shared only with potential matches</li>
                <li>We do not sell or share your data with third parties</li>
                <li>You can request data deletion at any time</li>
              </ul>

              <p><strong>3. User Responsibilities</strong></p>
              <ul class="small">
                <li>Provide accurate and truthful information in all reports</li>
                <li>Verify ownership before returning items</li>
                <li>Respect other users' privacy and contact information</li>
                <li>Report suspicious activity to administrators</li>
              </ul>

              <p><strong>4. Platform Usage</strong></p>
              <ul class="small">
                <li>Use Reunited only for its intended purpose</li>
                <li>Do not post false or misleading information</li>
                <li>Be respectful in all communications</li>
                <li>Follow campus policies and procedures</li>
              </ul>

              <div class="alert alert-warning small mt-2 mb-0">
                <i class="bi bi-exclamation-triangle me-1"></i>
                <strong>Important:</strong> By checking the agreement box below, you confirm that you have read, understood, and agree to all terms and conditions stated above.
              </div>
            </div>
            
            <div class="form-check mt-3">
              <input class="form-check-input" type="checkbox" name="terms_agreed" id="foundTermsAgreed" required>
              <label class="form-check-label fw-semibold" for="foundTermsAgreed">
                I have read and agree to the Terms and Conditions and Data Privacy Policy
              </label>
            </div>
          </div>
        </div>
        <div class="modal-footer">
          <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
          <button type="submit" class="btn btn-primary-custom" id="foundSubmitBtn">Submit Found Item</button>
        </div>
      </form>
    </div>
  </div>
</div>

<script>
// Camera functionality for lost and found modals
class CameraHandler {
    constructor(modalType) {
        this.modalType = modalType;
        this.video = null;
        this.canvas = null;
        this.stream = null;
        this.isCameraActive = false;
        this.init();
    }

    init() {
        this.video = document.getElementById(`${this.modalType}Video`);
        this.canvas = document.getElementById(`${this.modalType}Canvas`);
        this.bindEvents();
    }

    bindEvents() {
        // Start camera
        document.getElementById(`${this.modalType}StartCamera`).addEventListener('click', () => {
            this.startCamera();
        });

        // Capture photo
        document.getElementById(`${this.modalType}CapturePhoto`).addEventListener('click', () => {
            this.capturePhoto();
        });

        // Retake photo
        document.getElementById(`${this.modalType}RetakePhoto`).addEventListener('click', () => {
            this.retakePhoto();
        });

        // Stop camera
        document.getElementById(`${this.modalType}StopCamera`).addEventListener('click', () => {
            this.stopCamera();
        });

        // Stop camera when modal is closed
        const modal = document.getElementById(`${this.modalType}ItemModal`);
        if (modal) {
            modal.addEventListener('hidden.bs.modal', () => {
                this.stopCamera();
            });
        }
    }

    async startCamera() {
        try {
            // Hide file input warning if visible
            const faceWarning = document.getElementById(`${this.modalType}FaceWarning`);
            if (faceWarning) faceWarning.style.display = 'none';

            // Remove any existing error messages
            const existingError = document.getElementById(`${this.modalType}CameraError`);
            if (existingError) {
                existingError.remove();
            }

            // Clear file input when starting camera
            clearFileInput(this.modalType);

            // Basic camera availability check
            if (!navigator.mediaDevices || !navigator.mediaDevices.getUserMedia) {
                this.showCameraError(
                    'Camera not supported', 
                    'Your browser does not support camera access. Please try using Chrome, Firefox, or Safari.'
                );
                return;
            }

            // Show loading state
            const startButton = document.getElementById(`${this.modalType}StartCamera`);
            const originalText = startButton.innerHTML;
            startButton.innerHTML = '<i class="bi bi-hourglass-split me-1"></i>Accessing Camera...';
            startButton.disabled = true;

            // Try different camera constraints
            const constraints = {
                video: {
                    facingMode: 'environment', // Prefer rear camera
                    width: { ideal: 1280 },
                    height: { ideal: 720 }
                },
                audio: false
            };

            this.stream = await navigator.mediaDevices.getUserMedia(constraints);
            this.video.srcObject = this.stream;
            this.isCameraActive = true;

            // Wait for video to be ready
            this.video.onloadedmetadata = () => {
                // Show camera elements
                document.getElementById(`${this.modalType}CameraPreview`).style.display = 'block';
                document.getElementById(`${this.modalType}CapturePhoto`).style.display = 'inline-block';
                document.getElementById(`${this.modalType}StopCamera`).style.display = 'inline-block';
                document.getElementById(`${this.modalType}StartCamera`).style.display = 'none';

                // Hide captured preview if exists
                document.getElementById(`${this.modalType}CapturedPreview`).style.display = 'none';

                // Reset button
                startButton.innerHTML = originalText;
                startButton.disabled = false;

                console.log('Camera started successfully');
            };

        } catch (error) {
            console.error('Error accessing camera:', error);
            
            // Reset button
            const startButton = document.getElementById(`${this.modalType}StartCamera`);
            startButton.innerHTML = '<i class="bi bi-camera-video me-1"></i>Start Camera';
            startButton.disabled = false;
            
            this.handleCameraError(error);
        }
    }

    capturePhoto() {
        if (!this.isCameraActive) return;

        const context = this.canvas.getContext('2d');
        
        // Set canvas dimensions to match video
        this.canvas.width = this.video.videoWidth;
        this.canvas.height = this.video.videoHeight;
        
        // Draw current video frame to canvas
        context.drawImage(this.video, 0, 0, this.canvas.width, this.canvas.height);
        
        // Convert to data URL (JPEG format with quality 0.8)
        const imageData = this.canvas.toDataURL('image/jpeg', 0.8);
        
        // Display captured image
        const capturedImage = document.getElementById(`${this.modalType}CapturedImage`);
        capturedImage.src = imageData;
        
        // Store image data in hidden input
        document.getElementById(`${this.modalType}CapturedImageData`).value = imageData;
        
        // Clear any existing file input
        clearFileInput(this.modalType);
        
        // Show captured preview and retake button
        document.getElementById(`${this.modalType}CapturedPreview`).style.display = 'block';
        document.getElementById(`${this.modalType}RetakePhoto`).style.display = 'inline-block';
        document.getElementById(`${this.modalType}CapturePhoto`).style.display = 'none';
        
        // Stop camera after capture
        this.stopCamera();
        
        console.log('Photo captured successfully');
    }

    retakePhoto() {
        // Clear captured image
        document.getElementById(`${this.modalType}CapturedImage`).src = '';
        document.getElementById(`${this.modalType}CapturedImageData`).value = '';
        document.getElementById(`${this.modalType}CapturedPreview`).style.display = 'none';
        document.getElementById(`${this.modalType}RetakePhoto`).style.display = 'none';
        
        // Clear file input as well when retaking
        clearFileInput(this.modalType);
        
        // Restart camera
        this.startCamera();
    }

    stopCamera() {
        if (this.stream) {
            this.stream.getTracks().forEach(track => track.stop());
            this.stream = null;
        }
        
        this.isCameraActive = false;
        
        // Reset UI
        document.getElementById(`${this.modalType}CameraPreview`).style.display = 'none';
        document.getElementById(`${this.modalType}StartCamera`).style.display = 'inline-block';
        document.getElementById(`${this.modalType}CapturePhoto`).style.display = 'none';
        document.getElementById(`${this.modalType}StopCamera`).style.display = 'none';
        
        console.log('Camera stopped');
    }

    handleCameraError(error) {
        console.error('Camera error details:', error);
        
        let errorMessage = 'Unable to access camera. ';
        let detailedMessage = '';
        
        if (error.name === 'NotAllowedError') {
            errorMessage += 'Camera permission was denied.';
            detailedMessage = 'Please allow camera access in your browser settings. ' +
                             'Look for the camera icon in your address bar and click "Allow".';
        } else if (error.name === 'NotFoundError') {
            errorMessage += 'No camera found on your device.';
            detailedMessage = 'Please check if your device has a camera and it\'s not being used by another application.';
        } else if (error.name === 'NotSupportedError') {
            errorMessage += 'Camera not supported in your browser.';
            detailedMessage = 'Please try using Chrome, Firefox, or Safari. ' +
                             'Make sure you\'re accessing the site over HTTPS.';
        } else if (error.name === 'NotReadableError') {
            errorMessage += 'Camera is already in use.';
            detailedMessage = 'Another application might be using your camera. ' +
                             'Please close other camera applications and try again.';
        } else if (error.name === 'OverconstrainedError') {
            errorMessage += 'Camera configuration not supported.';
            detailedMessage = 'Trying to use different camera settings. Please try again.';
        } else {
            errorMessage += 'Please try again or upload an image file instead.';
            detailedMessage = 'Technical details: ' + error.message;
        }
        
        this.showCameraError(errorMessage, detailedMessage);
    }

    showCameraError(message, detailedMessage = '') {
        // Remove any existing error messages
        const existingError = document.getElementById(`${this.modalType}CameraError`);
        if (existingError) {
            existingError.remove();
        }
        
        // Create new error message
        const errorDiv = document.createElement('div');
        errorDiv.id = `${this.modalType}CameraError`;
        errorDiv.className = 'alert alert-warning mt-2';
        errorDiv.style.display = 'block';
        
        let errorHTML = `<i class="bi bi-exclamation-triangle me-2"></i><strong>${message}</strong>`;
        if (detailedMessage) {
            errorHTML += `<div class="mt-1 small">${detailedMessage}</div>`;
        }
        
        errorHTML += `<div class="mt-2 small">
            <strong>Tips:</strong>
            <ul class="mb-1 mt-1">
                <li>Make sure you're using HTTPS</li>
                <li>Allow camera permissions when prompted</li>
                <li>Try using a different browser</li>
                <li>Restart your browser if issues persist</li>
            </ul>
        </div>`;
        
        errorDiv.innerHTML = errorHTML;
        
        // Insert after camera controls
        const cameraSection = document.querySelector(`#${this.modalType}ItemModal .camera-section`);
        if (cameraSection) {
            cameraSection.appendChild(errorDiv);
        }
        
        // Auto-hide after 8 seconds
        setTimeout(() => {
            if (errorDiv.parentNode) {
                errorDiv.style.opacity = '0';
                setTimeout(() => {
                    if (errorDiv.parentNode) {
                        errorDiv.remove();
                    }
                }, 500);
            }
        }, 8000);
    }
}

// Utility functions for file and camera management
function clearFileInput(modalType) {
    const fileInput = document.getElementById(`${modalType}ItemImage`);
    if (fileInput) {
        fileInput.value = ''; // Clear the file selection
        console.log(`Cleared file input for ${modalType} modal`);
    }
}

function clearCamera(modalType) {
    // Clear captured image data
    document.getElementById(`${modalType}CapturedImageData`).value = '';
    document.getElementById(`${modalType}CapturedPreview`).style.display = 'none';
    document.getElementById(`${modalType}RetakePhoto`).style.display = 'none';
    
    // Make sure capture button is visible if needed
    const captureBtn = document.getElementById(`${modalType}CapturePhoto`);
if (captureBtn) {
    captureBtn.style.display = 'none';   // hide it, not show it
}

    
    console.log(`Cleared camera data for ${modalType} modal`);
}

// Toggle camera section when file input is focused/blurred
function setupCameraSectionToggle() {
    const lostImageInput = document.getElementById('lostItemImage');
    const foundImageInput = document.getElementById('foundItemImage');
    const lostCameraSection = document.getElementById('lostCameraSection');
    const foundCameraSection = document.getElementById('foundCameraSection');

    // Lost item modal
    if (lostImageInput && lostCameraSection) {
        lostImageInput.addEventListener('focus', function() {
            lostCameraSection.style.display = 'block';
        });
        
        lostImageInput.addEventListener('blur', function() {
            // Only hide if no camera is active and no photo is captured
            const lostCameraHandler = window.lostCameraHandler;
            if (!lostCameraHandler || !lostCameraHandler.isCameraActive) {
                const hasCapturedImage = document.getElementById('lostCapturedImageData').value;
                if (!hasCapturedImage) {
                    lostCameraSection.style.display = 'none';
                }
            }
        });
    }

    // Found item modal
    if (foundImageInput && foundCameraSection) {
        foundImageInput.addEventListener('focus', function() {
            foundCameraSection.style.display = 'block';
        });
        
        foundImageInput.addEventListener('blur', function() {
            // Only hide if no camera is active and no photo is captured
            const foundCameraHandler = window.foundCameraHandler;
            if (!foundCameraHandler || !foundCameraHandler.isCameraActive) {
                const hasCapturedImage = document.getElementById('foundCapturedImageData').value;
                if (!hasCapturedImage) {
                    foundCameraSection.style.display = 'none';
                }
            }
        });
    }

    // Also hide camera sections when modals close
    const lostModal = document.getElementById('lostItemModal');
    const foundModal = document.getElementById('foundItemModal');

    if (lostModal) {
        lostModal.addEventListener('hidden.bs.modal', function() {
            if (lostCameraSection) lostCameraSection.style.display = 'none';
        });
    }

    if (foundModal) {
        foundModal.addEventListener('hidden.bs.modal', function() {
            if (foundCameraSection) foundCameraSection.style.display = 'none';
        });
    }
}

// Initialize camera handlers when modals are shown
document.addEventListener('DOMContentLoaded', function() {
    // Setup camera section toggle first
    setupCameraSectionToggle();
    
    // Initialize when lost modal is shown
    const lostModal = document.getElementById('lostItemModal');
    if (lostModal) {
        lostModal.addEventListener('show.bs.modal', function() {
            setTimeout(() => {
                window.lostCameraHandler = new CameraHandler('lost');
            }, 100);
        });
    }
    
    // Initialize when found modal is shown
    const foundModal = document.getElementById('foundItemModal');
    if (foundModal) {
        foundModal.addEventListener('show.bs.modal', function() {
            setTimeout(() => {
                window.foundCameraHandler = new CameraHandler('found');
            }, 100);
        });
    }
    
    // Handle form submission to convert captured image to file
    document.getElementById('lostItemForm')?.addEventListener('submit', function(e) {
        // For lost items, image is optional - always allow submission
        handleCapturedImageSubmission(e, 'lost');
    });

    document.getElementById('foundItemForm')?.addEventListener('submit', function(e) {
        // For found items, image is required
        if (!handleCapturedImageSubmission(e, 'found')) {
            e.preventDefault();
        }
    });
    
    // Clear camera when file is selected (bidirectional clearing)
    document.getElementById('lostItemImage')?.addEventListener('change', function() {
        if (this.files.length > 0) {
            clearCamera('lost');
        }
    });
    
    document.getElementById('foundItemImage')?.addEventListener('change', function() {
        if (this.files.length > 0) {
            clearCamera('found');
        }
    });
});

// Handle captured image conversion and submission
function handleCapturedImageSubmission(event, modalType) {
    const capturedImageData = document.getElementById(`${modalType}CapturedImageData`).value;
    const fileInput = document.getElementById(`${modalType}ItemImage`);
    
    console.log('Submission check:', {
        modalType,
        hasCapturedImage: !!capturedImageData,
        hasFileInput: !!fileInput,
        fileCount: fileInput?.files.length || 0
    });
    
    // If user captured a photo but no file is selected
    if (capturedImageData && (!fileInput || fileInput.files.length === 0)) {
        console.log('Converting captured photo to file...');
        
        // Convert data URL to Blob and create File object
        const blob = dataURLtoBlob(capturedImageData);
        const file = new File([blob], `captured_photo_${Date.now()}.jpg`, { 
            type: 'image/jpeg',
            lastModified: new Date().getTime()
        });
        
        // Create a DataTransfer object to set the file
        const dataTransfer = new DataTransfer();
        dataTransfer.items.add(file);
        fileInput.files = dataTransfer.files;
        
        console.log('Captured photo converted to file for submission:', file.name);
    }
    
    // For FOUND items only, ensure there's either a file or captured image
    if (modalType === 'found') {
        const hasImage = fileInput.files.length > 0 || capturedImageData;
        console.log('Found item image check:', { hasImage, fileCount: fileInput.files.length, hasCapturedData: !!capturedImageData });
        
        if (!hasImage) {
            // Show user-friendly error message
            const errorDiv = document.createElement('div');
            errorDiv.className = 'alert alert-danger alert-dismissible fade show mt-3';
            errorDiv.innerHTML = `
                <i class="bi bi-exclamation-triangle-fill me-2"></i>
                <strong>Image Required:</strong> For found items, please either upload an image file or take a photo with the camera to help identify the item.
                <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
            `;
            
            // Insert the error message at the top of the modal body
            const modalBody = document.querySelector(`#${modalType}ItemModal .modal-body`);
            if (modalBody) {
                modalBody.insertBefore(errorDiv, modalBody.firstChild);
                
                // Scroll to the error message
                errorDiv.scrollIntoView({ behavior: 'smooth', block: 'center' });
            }
            
            return false;
        }
    }
    
    // For LOST items, image is optional, so no validation needed
    return true;
}

// Utility function to convert data URL to Blob
function dataURLtoBlob(dataURL) {
    const parts = dataURL.split(';base64,');
    const contentType = parts[0].split(':')[1];
    const raw = window.atob(parts[1]);
    const rawLength = raw.length;
    const uInt8Array = new Uint8Array(rawLength);
    
    for (let i = 0; i < rawLength; ++i) {
        uInt8Array[i] = raw.charCodeAt(i);
    }
    
    return new Blob([uInt8Array], { type: contentType });
}

// Enhanced form validation for terms agreement and face detection warnings
document.addEventListener('DOMContentLoaded', function() {
  // Handle terms agreement validation
  const lostTermsCheckbox = document.getElementById('lostTermsAgreed');
  const foundTermsCheckbox = document.getElementById('foundTermsAgreed');
  const lostSubmitBtn = document.getElementById('lostSubmitBtn');
  const foundSubmitBtn = document.getElementById('foundSubmitBtn');
  
  if (lostTermsCheckbox && lostSubmitBtn) {
    lostTermsCheckbox.addEventListener('change', function() {
      lostSubmitBtn.disabled = !this.checked;
    });
    // Initialize state
    lostSubmitBtn.disabled = !lostTermsCheckbox.checked;
  }
  
  if (foundTermsCheckbox && foundSubmitBtn) {
    foundTermsCheckbox.addEventListener('change', function() {
      foundSubmitBtn.disabled = !this.checked;
    });
    // Initialize state
    foundSubmitBtn.disabled = !foundTermsCheckbox.checked;
  }

  // Show face detection warnings when file input is focused
  const lostImageInput = document.getElementById('lostItemImage');
  const foundImageInput = document.getElementById('foundItemImage');
  const lostFaceWarning = document.getElementById('lostFaceWarning');
  const foundFaceWarning = document.getElementById('foundFaceWarning');

  if (lostImageInput && lostFaceWarning) {
    lostImageInput.addEventListener('focus', function() {
      lostFaceWarning.style.display = 'block';
    });
    lostImageInput.addEventListener('blur', function() {
      lostFaceWarning.style.display = 'none';
    });
  }

  if (foundImageInput && foundFaceWarning) {
    foundImageInput.addEventListener('focus', function() {
      foundFaceWarning.style.display = 'block';
    });
    foundImageInput.addEventListener('blur', function() {
      foundFaceWarning.style.display = 'none';
    });
  }

  // Clear flash messages when modal is closed
  const lostModal = document.getElementById('lostItemModal');
  const foundModal = document.getElementById('foundItemModal');

  if (lostModal) {
    lostModal.addEventListener('hidden.bs.modal', function() {
      const alerts = this.querySelectorAll('.alert');
      alerts.forEach(alert => {
        alert.remove();
      });
    });
  }

  if (foundModal) {
    foundModal.addEventListener('hidden.bs.modal', function() {
      const alerts = this.querySelectorAll('.alert');
      alerts.forEach(alert => {
        alert.remove();
      });
    });
  }

  // Add form repopulation when modals open
  if (lostModal) {
    lostModal.addEventListener('show.bs.modal', function() {
      // Small delay to ensure modal is fully rendered
      setTimeout(repopulateLostForm, 100);
    });
  }

  if (foundModal) {
    foundModal.addEventListener('show.bs.modal', function() {
      // Small delay to ensure modal is fully rendered
      setTimeout(repopulateFoundForm, 100);
    });
  }
});

// Function to redirect to item pages - MUST BE GLOBAL
function redirectToItemPage(itemType, itemId) {
  if (itemType === 'lost') {
    window.location.href = "{{ url_for('lost') }}?show_item=" + itemId;
  } else {
    window.location.href = "{{ url_for('found') }}?show_item=" + itemId;
  }
}

// Function to repopulate lost form from sessionStorage
function repopulateLostForm() {
  const lostFormData = sessionStorage.getItem('lostFormData');
  if (lostFormData) {
    try {
      const data = JSON.parse(lostFormData);
      
      // Fill form fields
      const titleInput = document.querySelector('#lostItemModal input[name="title"]');
      const categorySelect = document.querySelector('#lostItemModal select[name="category"]');
      const descriptionTextarea = document.querySelector('#lostItemModal textarea[name="description"]');
      const locationInput = document.querySelector('#lostItemModal input[name="location_reported"]');
      const rewardInput = document.querySelector('#lostItemModal input[name="reward"]');
      
      if (titleInput) titleInput.value = data.title || '';
      if (categorySelect) categorySelect.value = data.category || '';
      if (descriptionTextarea) descriptionTextarea.value = data.description || '';
      if (locationInput) locationInput.value = data.location_reported || '';
      if (rewardInput) rewardInput.value = data.reward || '';
      
      console.log('✅ Lost form repopulated with stored data');
      
      // Clear the stored data after use
      sessionStorage.removeItem('lostFormData');
    } catch (e) {
      console.error('Error repopulating lost form:', e);
    }
  }
}

// Function to repopulate found form from sessionStorage
function repopulateFoundForm() {
  const foundFormData = sessionStorage.getItem('foundFormData');
  if (foundFormData) {
    try {
      const data = JSON.parse(foundFormData);
      
      // Fill form fields
      const titleInput = document.querySelector('#foundItemModal input[name="title"]');
      const categorySelect = document.querySelector('#foundItemModal select[name="category"]');
      const descriptionTextarea = document.querySelector('#foundItemModal textarea[name="description"]');
      const locationInput = document.querySelector('#foundItemModal input[name="location_reported"]');
      
      if (titleInput) titleInput.value = data.title || '';
      if (categorySelect) categorySelect.value = data.category || '';
      if (descriptionTextarea) descriptionTextarea.value = data.description || '';
      if (locationInput) locationInput.value = data.location_reported || '';
      
      console.log('✅ Found form repopulated with stored data');
      
      // Clear the stored data after use
      sessionStorage.removeItem('foundFormData');
    } catch (e) {
      console.error('Error repopulating found form:', e);
    }
  }
}

document.addEventListener("DOMContentLoaded", function () {
  // Auto-open modals based on URL hash and repopulate form data
  if (window.location.hash === "#lostItemModal") {
    const modal = new bootstrap.Modal(document.getElementById('lostItemModal'));
    modal.show();
    // Repopulate form data after modal is shown
    setTimeout(repopulateLostForm, 500);
  }
  if (window.location.hash === "#foundItemModal") {
    const modal = new bootstrap.Modal(document.getElementById('foundItemModal'));
    modal.show();
    // Repopulate form data after modal is shown
    setTimeout(repopulateFoundForm, 500);
  }
  if (window.location.hash === "#feedbackModal") {
    const modal = new bootstrap.Modal(document.getElementById('feedbackModal'));
    modal.show();
  }

  const stars = document.querySelectorAll('.rating-stars input[type="radio"]');
  const starLabels = document.querySelectorAll('.rating-stars .star');
  
  starLabels.forEach((label, index) => {
    label.addEventListener('click', function() {
      const rating = index + 1;
      stars[rating - 1].checked = true;
      updateStarDisplay();
    });
    
    label.addEventListener('mouseover', function() {
      starLabels.forEach((star, i) => {
        if (i <= index) {
          star.querySelector('i').className = 'bi bi-star-fill';
          star.style.color = 'var(--color-warning)';
        } else {
          star.querySelector('i').className = 'bi bi-star';
          star.style.color = 'var(--color-gray-300)';
        }
      });
    });
  });
  
  document.querySelector('.rating-stars').addEventListener('mouseleave', function() {
    updateStarDisplay();
  });
  
  function updateStarDisplay() {
    const checkedStar = document.querySelector('.rating-stars input[type="radio"]:checked');
    if (checkedStar) {
      const rating = parseInt(checkedStar.value);
      starLabels.forEach((star, i) => {
        if (i < rating) {
          star.querySelector('i').className = 'bi bi-star-fill';
          star.style.color = 'var(--color-warning)';
        } else {
          star.querySelector('i').className = 'bi bi-star';
          star.style.color = 'var(--color-gray-300)';
        }
      });
    } else {
      starLabels.forEach(star => {
        star.querySelector('i').className = 'bi bi-star';
        star.style.color = 'var(--color-gray-300)';
      });
    }
  }

  let currentSlide = 0;
  const carousel = document.getElementById('feedbackCarousel');
  const slides = document.querySelectorAll('.feedback-slide');
  
  function getVisibleSlides() {
    const width = window.innerWidth;
    if (width >= 1200) return 3;
    if (width >= 768) return 2;
    return 1;
  }
  
  function updateCarousel() {
    if (carousel && slides.length > 0) {
      const visibleSlides = getVisibleSlides();
      const slideWidth = carousel.offsetWidth / visibleSlides;
      const maxSlide = Math.max(0, slides.length - visibleSlides);
      
      if (currentSlide > maxSlide) {
        currentSlide = maxSlide;
      }
      
      carousel.style.transform = `translateX(-${currentSlide * slideWidth}px)`;
      
      const prevBtn = document.getElementById('prevBtn');
      const nextBtn = document.getElementById('nextBtn');
      
      if (prevBtn) prevBtn.disabled = currentSlide === 0;
      if (nextBtn) nextBtn.disabled = currentSlide >= maxSlide;
    }
  }
  
  window.nextFeedback = function() {
    const visibleSlides = getVisibleSlides();
    const maxSlide = Math.max(0, slides.length - visibleSlides);
    if (currentSlide < maxSlide) {
      currentSlide++;
      updateCarousel();
    }
  };
  
  window.previousFeedback = function() {
    if (currentSlide > 0) {
      currentSlide--;
      updateCarousel();
    }
  };
  
  window.addEventListener('resize', updateCarousel);
  
  updateCarousel();

  // Feedback modal functionality
  const feedbackCards = document.querySelectorAll('.clickable-feedback');
  const feedbackModal = new bootstrap.Modal(document.getElementById('feedbackDetailModal'));
  
  feedbackCards.forEach(card => {
    card.addEventListener('click', function() {
      const userName = this.getAttribute('data-user-name');
      const profilePicture = this.getAttribute('data-profile-picture');
      const rating = parseInt(this.getAttribute('data-rating'));
      const message = this.getAttribute('data-message');
      const date = this.getAttribute('data-date');
      
      // Populate modal with data
      document.getElementById('modalUserName').textContent = userName;
      document.getElementById('modalFullMessage').textContent = message;
      document.getElementById('modalDate').textContent = date;
      
      // Handle profile picture
      const modalProfilePicture = document.getElementById('modalProfilePicture');
      modalProfilePicture.innerHTML = ''; // Clear previous content
      
      if (profilePicture) {
        const img = document.createElement('img');
        img.src = profilePicture;
        img.alt = userName;
        img.className = 'modal-profile-img';
        modalProfilePicture.appendChild(img);
      } else {
        const placeholder = document.createElement('div');
        placeholder.className = 'modal-profile-placeholder';
        placeholder.innerHTML = '<i class="bi bi-person-fill"></i>';
        modalProfilePicture.appendChild(placeholder);
      }
      
      // Handle rating
      const modalRating = document.getElementById('modalRating');
      modalRating.innerHTML = ''; // Clear previous stars
      
      if (rating) {
        for (let i = 0; i < rating; i++) {
          const star = document.createElement('i');
          star.className = 'bi bi-star-fill';
          modalRating.appendChild(star);
        }
        for (let i = 0; i < (5 - rating); i++) {
          const star = document.createElement('i');
          star.className = 'bi bi-star';
          modalRating.appendChild(star);
        }
      } else {
        modalRating.innerHTML = '<span class="text-muted">No rating</span>';
      }
      
      // Show modal
      feedbackModal.show();
    });
  });
  
  // Prevent carousel controls from triggering card clicks
  const carouselControls = document.querySelectorAll('.carousel-control');
  carouselControls.forEach(control => {
    control.addEventListener('click', function(e) {
      e.stopPropagation();
    });
  });
});
</script>
<style>
.rating-stars {
  display: flex;
  flex-direction: row;
  justify-content: flex-start;
}

.rating-stars input[type="radio"] {
  display: none;
}

.rating-stars .star {
  cursor: pointer;
  font-size: 1.5rem;
  color: #dee2e6;
  margin-right: 0.25rem;
  transition: color 0.2s;
}

.rating-stars .star:hover {
  color: #ffc107;
}

.rating-stars .star i {
  transition: all 0.2s ease;
}

.stats-icon {
  background: transparent !important;
  font-size: 1.5rem;
  width: 60px;
  height: 60px;
  display: flex;
  align-items: center;
  justify-content: center;
  border-radius: 12px;
  margin-bottom: 1rem;
}

/* Community Feedback Section */
.feedback-carousel-wrapper {
  position: relative;
  padding: 0 40px;
  margin: 16px 0;
}

.carousel-control {
  position: absolute;
  top: 50%;
  transform: translateY(-50%);
  background: #fff;
  border: 2px solid #007bff;
  border-radius: 50%;
  width: 36px;
  height: 36px;
  display: flex;
  align-items: center;
  justify-content: center;
  cursor: pointer;
  transition: all 0.3s ease;
  z-index: 15;
  box-shadow: 0 4px 12px rgba(0, 123, 255, 0.25);
  color: #007bff;
  font-size: 16px;
}

.carousel-control:hover:not(:disabled) {
  background: #007bff;
  color: #fff;
  box-shadow: 0 6px 20px rgba(0, 123, 255, 0.4);
  transform: translateY(-50%) scale(1.1);
}

.carousel-control:disabled {
  opacity: 0.3;
  cursor: not-allowed;
  transform: translateY(-50%);
  background: #f8f9fa;
  border-color: #dee2e6;
  color: #6c757d;
}

.carousel-control-prev {
  left: 8px;
}

.carousel-control-next {
  right: 8px;
}

.feedback-carousel-container {
  overflow: hidden;
  width: 100%;
  border-radius: 8px;
}

.feedback-carousel {
  display: flex;
  transition: transform 0.4s ease;
  gap: 16px;
}

.feedback-slide {
  flex-shrink: 0;
  width: 100%;
}

/* Responsive slide widths */
@media (min-width: 1200px) {
  .feedback-slide {
    width: calc((100% - 32px) / 3);
  }
}

@media (min-width: 768px) and (max-width: 1199px) {
  .feedback-slide {
    width: calc((100% - 16px) / 2);
  }
}

/* Mobile Responsive Improvements */
@media (max-width: 767px) {
  .feedback-slide {
    width: 100%;
    padding: 0 8px;
  }
  
  .feedback-carousel-wrapper {
    padding: 0 20px;
  }
  
  .carousel-control {
    width: 32px;
    height: 32px;
    font-size: 14px;
    background: rgba(255, 255, 255, 0.9);
    backdrop-filter: blur(5px);
    border: 1px solid #dee2e6;
  }
  
  .carousel-control-prev {
    left: -10px;
  }
  
  .carousel-control-next {
    right: -10px;
  }
  
  .feedback-carousel {
    gap: 12px;
  }
}

/* Clickable feedback cards */
.clickable-feedback {
  cursor: pointer;
  transition: all 0.3s ease;
}

.clickable-feedback:hover {
  transform: translateY(-2px);
  box-shadow: 0 6px 20px rgba(0, 0, 0, 0.12);
}

/* Clickable item cards */
.clickable-item {
  cursor: pointer;
  transition: all 0.3s ease;
}

.clickable-item:hover {
  transform: translateY(-4px);
  box-shadow: 0 8px 25px rgba(0, 0, 0, 0.15);
}

.feedback-card {
  background: #fff;
  border: 1px solid #e9ecef;
  border-radius: 12px;
  padding: 20px;
  height: 100%;
  box-shadow: 0 4px 12px rgba(0, 0, 0, 0.08);
  transition: all 0.3s ease;
  min-height: 200px;
  display: flex;
  flex-direction: column;
}

.feedback-card:hover {
  box-shadow: 0 8px 24px rgba(0, 0, 0, 0.15);
  transform: translateY(-4px);
}

@media (max-width: 767px) {
  .feedback-card {
    padding: 16px;
    min-height: 180px;
  }
}

.feedback-header {
  display: flex;
  align-items: flex-start;
  margin-bottom: 12px;
  min-height: 48px;
}

@media (max-width: 767px) {
  .feedback-header {
    align-items: center;
    margin-bottom: 10px;
    min-height: 44px;
  }
}

.profile-picture {
  width: 48px;
  height: 48px;
  margin-right: 12px;
  flex-shrink: 0;
}

@media (max-width: 767px) {
  .profile-picture {
    width: 40px;
    height: 40px;
    margin-right: 10px;
  }
}

.profile-img {
  width: 100%;
  height: 100%;
  border-radius: 50%;
  object-fit: cover;
  border: 2px solid #e9ecef;
}

.profile-placeholder {
  width: 100%;
  height: 100%;
  border-radius: 50%;
  background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
  display: flex;
  align-items: center;
  justify-content: center;
  color: white;
  font-size: 20px;
}

@media (max-width: 767px) {
  .profile-placeholder {
    font-size: 16px;
  }
}

.feedback-info {
  flex: 1;
  min-width: 0;
  display: flex;
  flex-direction: column;
  justify-content: center;
  overflow: hidden;
}

.user-name {
  margin: 0 0 4px 0;
  font-weight: 600;
  font-size: 15px;
  color: #2c3e50;
  line-height: 1.2;
  white-space: nowrap;
  overflow: hidden;
  text-overflow: ellipsis;
  max-width: 100%;
}

@media (max-width: 767px) {
  .user-name {
    font-size: 14px;
    margin-bottom: 3px;
  }
}

.rating-display {
  color: #ffc107;
  font-size: 13px;
  line-height: 1;
  display: flex;
  flex-wrap: nowrap;
}

.rating-display i {
  margin-right: 1px;
  flex-shrink: 0;
}

@media (max-width: 767px) {
  .rating-display {
    font-size: 12px;
  }
  
  .rating-display i {
    margin-right: 0;
  }
}

.feedback-message {
  margin: 0 0 12px 0;
  font-size: 14px;
  line-height: 1.5;
  color: #495057;
  display: -webkit-box;
  -webkit-line-clamp: 3;
  -webkit-box-orient: vertical;
  overflow: hidden;
  flex: 1;
  min-height: 60px;
}

@media (max-width: 767px) {
  .feedback-message {
    font-size: 13px;
    line-height: 1.4;
    -webkit-line-clamp: 3;
    min-height: 55px;
    margin-bottom: 10px;
  }
}

.feedback-date {
  color: #6c757d;
  font-size: 12px;
  font-weight: 500;
  margin-top: auto;
}

@media (max-width: 767px) {
  .feedback-date {
    font-size: 11px;
  }
}

/* Modal specific styles */
.modal-profile-picture {
  width: 60px;
  height: 60px;
  flex-shrink: 0;
}

.modal-profile-img {
  width: 100%;
  height: 100%;
  border-radius: 50%;
  object-fit: cover;
  border: 3px solid #e9ecef;
}

.modal-profile-placeholder {
  width: 100%;
  height: 100%;
  border-radius: 50%;
  background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
  display: flex;
  align-items: center;
  justify-content: center;
  color: white;
  font-size: 24px;
  border: 3px solid #e9ecef;
}

.feedback-full-message {
  font-size: 16px;
  line-height: 1.6;
  color: #495057;
  white-space: pre-line;
}

/* Item modal styles */
.item-image-container {
  border-radius: 8px;
  overflow: hidden;
}

.item-details {
  padding: 10px 0;
}

.item-details strong {
  color: #2c3e50;
  font-weight: 600;
}

.description-section {
  background: #f8f9fa;
  padding: 15px;
  border-radius: 8px;
  border-left: 4px solid #007bff;
}

/* Mobile responsive for modals */
@media (max-width: 767px) {
  .modal-profile-picture {
    width: 50px;
    height: 50px;
  }
  
  .modal-profile-placeholder {
    font-size: 20px;
  }
  
  .feedback-full-message {
    font-size: 14px;
  }
  
  #modalUserName {
    font-size: 16px;
  }
  
  .item-image-container img {
    max-height: 200px !important;
    height: 200px !important;
  }
  
  .modal-body .row {
    gap: 15px;
  }
  
  .description-section {
    margin-top: 15px;
  }
}

/* Ensure modal rating stars are properly sized */
#modalRating {
  font-size: 16px;
}

#modalRating i {
  margin-right: 2px;
}

@media (max-width: 767px) {
  #modalRating {
    font-size: 14px;
  }
}

/* Ensure proper badge sizing in modal */
#modalItemType {
  font-size: 14px !important;
  padding: 8px 12px;
}

/* Camera Section Styles */
.camera-section {
    border: 2px dashed #dee2e6;
    border-radius: 8px;
    padding: 15px;
    background: #f8f9fa;
}

.camera-preview video {
    background: #000;
    border-radius: 8px;
}

.camera-controls {
    margin: 10px 0;
}

.captured-preview img {
    max-height: 200px;
    object-fit: cover;
}

/* Required field indicator */
.text-danger {
    color: #dc3545 !important;
    font-weight: bold;
}

/* Mobile responsive */
@media (max-width: 768px) {
    .camera-preview video {
        max-height: 250px;
    }
    
    .camera-controls .btn {
        margin-bottom: 5px;
    }
}

/* Camera Loading States */
.btn:disabled {
    opacity: 0.6;
    cursor: not-allowed;
}

/* Camera Error Styles */
.camera-error {
    border-left: 4px solid #ffc107;
    background: #fffbf0;
}

.camera-guidance {
    background: #e7f3ff;
    border-radius: 6px;
    padding: 8px 12px;
    border-left: 4px solid #007bff;
    font-size: 0.875rem;
}

/* Smooth transitions */
.camera-preview, .captured-preview, .alert {
    transition: all 0.3s ease;
}

/* Mobile optimizations */
@media (max-width: 768px) {
    .camera-guidance {
        font-size: 0.8rem;
        padding: 6px 10px;
    }
}
</style>

{% endblock %}