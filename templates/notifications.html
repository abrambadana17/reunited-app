{% extends "base.html" %}
{% block title %}Notifications - Reunited{% endblock %}

{% block content %}
<div class="container-fluid">
  <div class="dashboard-header mb-4">
    <h1 class="fw-bold mb-2">Notifications ðŸ””</h1>
    <p class="mb-0 opacity-75">Stay updated about your items.</p>
  </div>

  <div class="list-group shadow-sm">
    {% for n in notifications %}
      <div class="list-group-item list-group-item-action mb-2 {% if not n.is_read %}list-group-item-warning{% endif %}">
        <div class="d-flex justify-content-between align-items-start">
          <div class="flex-grow-1 me-3">
            <p class="mb-1">{{ n.message | replace('\n', '<br>') | safe }}</p>
            <p>Contact the other party to coordinate the exchange and manage this possible match. Use the contact information provided in the match details to arrange a safe meeting location.</p>
            <small class="text-muted">{{ n.sent_at.strftime('%b %d, %Y %I:%M %p') }}</small>
          </div>
          <div class="d-flex align-items-center gap-2">
            <span class="badge {% if n.is_read %}bg-secondary{% else %}bg-primary{% endif %}">
              {{ "Read" if n.is_read else "New" }}
            </span>
            {% if not n.is_read %}
              <a href="{{ url_for('mark_notification_read', notif_id=n.id) }}" 
                 class="btn btn-sm btn-outline-secondary mobile-btn"
                 onclick="markAsRead(event, {{ n.id }})">
                Mark Read
              </a>
            {% endif %}
          </div>
        </div>
        
        {% if n.type == 'match_found' and n.match_id %}
          <div class="mt-3 pt-3 border-top">
            <div class="d-flex gap-2 justify-content-end">
              <div class="claim-status" 
                   data-notification-id="{{ n.id }}" 
                   data-user-id="{{ session.user_id }}"
                   data-match-id="{{ n.match_id }}"
                   data-is-read="{{ 'True' if n.is_read else 'False' }}">
                <div class="action-buttons-container">
                  <div class="d-flex flex-column flex-sm-row gap-2">
                    <!-- Buttons will be shown/hidden by JavaScript based on user's role and claim status -->
                    <button class="btn btn-primary-custom btn-sm claim-btn mobile-btn" 
                            data-action="claimed" 
                            data-notification-id="{{ n.id }}"
                            style="display: none;">
                      I Got My Item Back 
                    </button>
                    <button class="btn btn-primary-custom btn-sm claim-btn mobile-btn" 
                            data-action="returned" 
                            data-notification-id="{{ n.id }}"
                            style="display: none;">
                      I Returned The Item 
                    </button>
                  </div>
                </div>
                <div class="claim-status-text mt-2" style="display: none;">
                  <small class="text-muted"></small>
                </div>
              </div>
            </div>
          </div>
        {% endif %}
      </div>
    {% else %}
      <div class="list-group-item">
        <p class="text-muted mb-0">No notifications yet.</p>
      </div>
    {% endfor %}
  </div>
</div>

<style>
/* Mobile Responsiveness for Notifications */
@media (max-width: 768px) {
  .list-group-item {
    padding: 12px 10px;
  }
  
  .d-flex.justify-content-between.align-items-start {
    flex-direction: column;
    align-items: flex-start !important;
  }
  
  .d-flex.align-items-center.gap-2 {
    margin-top: 10px;
    width: 100%;
    justify-content: space-between;
  }
  
  .action-buttons-container {
    width: 100%;
  }
  
  .d-flex.flex-column.flex-sm-row.gap-2 {
    width: 100%;
  }
  
  .flex-grow-1.me-3 {
    margin-right: 0 !important;
    margin-bottom: 10px;
  }
  
  .claim-status .d-flex.justify-content-end {
    justify-content: flex-start !important;
  }
}

@media (max-width: 576px) {
  .container-fluid {
    padding-left: 10px;
    padding-right: 10px;
  }
  
  .dashboard-header h1 {
    font-size: 1.5rem;
  }
  
  .dashboard-header p {
    font-size: 0.9rem;
  }
  
  .list-group-item p {
    font-size: 0.9rem;
    line-height: 1.4;
  }
  
  .list-group-item small {
    font-size: 0.8rem;
  }
  
  .btn-sm {
    padding: 6px 12px;
    font-size: 0.85rem;
  }
}

/* Mobile button styles */
.mobile-btn {
    min-height: 44px;
    display: flex;
    align-items: center;
    justify-content: center;
}

.action-buttons-container {
    width: 100%;
}

@media (max-width: 576px) {
    .d-flex.flex-column.flex-sm-row.gap-2 {
        gap: 10px !important;
    }
}

.claim-status {
    width: 100%;
}

.d-flex.flex-column.flex-sm-row.gap-2 {
    align-items: stretch;
}
</style>

<script>
// Function to mark notification as read without hiding buttons
function markAsRead(event, notificationId) {
    event.preventDefault();
    
    fetch(`/notifications/read/${notificationId}`)
        .then(response => {
            if (response.ok) {
                const notificationItem = event.target.closest('.list-group-item');
                notificationItem.classList.remove('list-group-item-warning');
                const badge = notificationItem.querySelector('.badge');
                badge.textContent = 'Read';
                badge.className = 'badge bg-secondary';
                
                event.target.style.display = 'none';
                
                const statusDiv = notificationItem.querySelector('.claim-status');
                if (statusDiv) {
                    statusDiv.dataset.isRead = 'True';
                    checkClaimStatus(statusDiv);
                }
                
                showMessage('Notification marked as read', 'success');
            }
        })
        .catch(error => {
            console.error('Error marking as read:', error);
            showMessage('Error marking notification as read', 'error');
        });
}

// Function to check and update claim status
function checkClaimStatus(statusDiv) {
    const notificationId = statusDiv.dataset.notificationId;
    const currentUserId = parseInt(statusDiv.dataset.userId);
    const matchId = statusDiv.dataset.matchId;
    
    Promise.all([
        fetch(`/api/match-details/${matchId}`).then(r => r.json()),
        fetch(`/api/claim-status/${notificationId}`).then(r => r.json())
    ])
    .then(([matchData, claimData]) => {
        if (matchData.success && claimData.success) {
            const claimedBtn = statusDiv.querySelector('[data-action="claimed"]');
            const returnedBtn = statusDiv.querySelector('[data-action="returned"]');
            
            const isLostOwner = currentUserId === matchData.match.lost_user_id;
            const isFoundOwner = currentUserId === matchData.match.found_user_id;
            
            if (isLostOwner && claimedBtn) {
                claimedBtn.dataset.itemId = matchData.match.lost_item_id;
            }
            if (isFoundOwner && returnedBtn) {
                returnedBtn.dataset.itemId = matchData.match.found_item_id;
            }
            
            updateClaimUI(statusDiv, claimData.claim_status, currentUserId);
        }
    })
    .catch(error => {
        console.error('Error fetching data:', error);
    });
}

document.addEventListener('DOMContentLoaded', function() {
    const claimStatuses = document.querySelectorAll('.claim-status');
    
    claimStatuses.forEach(function(statusDiv) {
        checkClaimStatus(statusDiv);
    });
    
    // Handle claim button clicks
    document.addEventListener('click', function(e) {
        if (e.target.classList.contains('claim-btn')) {
            e.preventDefault();
            
            const button = e.target;
            const action = button.dataset.action;
            const itemId = button.dataset.itemId;
            const notificationId = button.dataset.notificationId;
            
            if (!itemId) {
                showMessage('Error: Item ID not found. Please refresh the page.', 'error');
                return;
            }
            
            button.disabled = true;
            const originalText = button.textContent;
            button.textContent = 'Processing...';
            
            fetch('/api/claim', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                },
                body: JSON.stringify({
                    notification_id: notificationId,
                    item_id: itemId,
                    action_type: action
                })
            })
            .then(response => response.json())
            .then(data => {
                if (data.success) {
                    const statusDiv = button.closest('.claim-status');
                    
                    // Simply hide the button after clicking - no replacement labels
                    button.style.display = 'none';
                    
                    const notificationItem = button.closest('.list-group-item');
                    notificationItem.classList.remove('list-group-item-warning');
                    const badge = notificationItem.querySelector('.badge');
                    badge.textContent = 'Read';
                    badge.className = 'badge bg-secondary';
                    
                    const markReadBtn = notificationItem.querySelector('.btn-outline-secondary');
                    if (markReadBtn) {
                        markReadBtn.style.display = 'none';
                    }
                    
                    statusDiv.dataset.isRead = 'True';
                    
                    showMessage(data.message, 'success');
                    
                    if (data.both_completed) {
                        showMessage('Both parties have confirmed! The item exchange is complete and the match is resolved.', 'info');
                        
                        const statusText = statusDiv.querySelector('.claim-status-text');
                        const statusTextContent = statusText.querySelector('small');
                        statusText.style.display = 'block';
                        statusTextContent.textContent = 'âœ… Exchange completed! Match resolved.';
                        statusTextContent.className = 'text-success';
                    }
                } else {
                    showMessage(data.errors.join(', '), 'error');
                    button.disabled = false;
                    button.textContent = originalText;
                }
            })
            .catch(error => {
                console.error('Error:', error);
                showMessage('An error occurred. Please try again.', 'error');
                button.disabled = false;
                button.textContent = originalText;
            });
        }
    });
});

function updateClaimUI(statusDiv, claimStatus, currentUserId) {
    const claimedBtn = statusDiv.querySelector('[data-action="claimed"]');
    const returnedBtn = statusDiv.querySelector('[data-action="returned"]');
    const statusText = statusDiv.querySelector('.claim-status-text');
    const statusTextContent = statusText.querySelector('small');
    
    // Reset all visibility
    if (claimedBtn) claimedBtn.style.display = 'none';
    if (returnedBtn) returnedBtn.style.display = 'none';
    statusText.style.display = 'none';
    
    // Check what actions have been taken
    const userClaimed = claimStatus.claimed && claimStatus.claimed.user_id === currentUserId;
    const userReturned = claimStatus.returned && claimStatus.returned.user_id === currentUserId;
    
    if (claimStatus.both_completed) {
        statusText.style.display = 'block';
        statusTextContent.textContent = 'âœ… Exchange completed! Match resolved.';
        statusTextContent.className = 'text-success';
        
    } else if (userClaimed || userReturned) {
        // User has already taken action - don't show any buttons
        statusText.style.display = 'block';
        if (userClaimed) {
            statusTextContent.textContent = 'You confirmed you received your item back.';
        } else {
            statusTextContent.textContent = 'You confirmed you returned the item.';
        }
        statusTextContent.className = 'text-info';
        
    } else {
        // User hasn't taken action yet - show appropriate button
        if (claimedBtn && claimedBtn.dataset.itemId) {
            claimedBtn.style.display = 'inline-block';
        }
        if (returnedBtn && returnedBtn.dataset.itemId) {
            returnedBtn.style.display = 'inline-block';
        }
    }
}

function showMessage(message, type) {
    const toast = document.createElement('div');
    toast.className = `alert alert-${type === 'error' ? 'danger' : type === 'success' ? 'success' : 'info'} alert-dismissible fade show position-fixed`;
    toast.style.top = '20px';
    toast.style.right = '20px';
    toast.style.zIndex = '9999';
    toast.innerHTML = `
        ${message}
        <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
    `;
    
    document.body.appendChild(toast);
    
    setTimeout(() => {
        if (toast.parentNode) {
            toast.parentNode.removeChild(toast);
        }
    }, 5000);
}
</script>
{% endblock %}