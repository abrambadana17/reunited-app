<!-- Replace your entire notifications.html template with this: -->
{% extends "base.html" %}
{% block title %}Notifications - Reunited{% endblock %}

{% block content %}
<div class="container-fluid">
  <div class="dashboard-header mb-4">
    <h1 class="fw-bold mb-2">Notifications ðŸ””</h1>
    <p class="mb-0 opacity-75">Stay updated about your items.</p>
  </div>

  <div class="list-group shadow-sm">
    {% for n in notifications %}
      <div class="list-group-item list-group-item-action mb-2 {% if not n.is_read %}list-group-item-warning{% endif %}">
        <div class="d-flex justify-content-between align-items-start">
          <div class="flex-grow-1 me-3">
            <p class="mb-1">{{ n.message | replace('\n', '<br>') | safe }}</p>
            <p>Contact the other party to coordinate the exchange and manage this possible match. Use the contact information provided in the match details to arrange a safe meeting location.</p>
            <small class="text-muted">{{ n.sent_at.strftime('%b %d, %Y %I:%M %p') }}</small>
          </div>
          <div class="d-flex align-items-center gap-2">
            <span class="badge {% if n.is_read %}bg-secondary{% else %}bg-primary{% endif %}">
              {{ "Read" if n.is_read else "New" }}
            </span>
            {% if not n.is_read %}
              <a href="{{ url_for('mark_notification_read', notif_id=n.id) }}" 
                 class="btn btn-sm btn-outline-secondary">
                Mark Read
              </a>
            {% endif %}
          </div>
        </div>
        
        {% if n.type == 'match_found' and n.match_id %}
          <div class="mt-3 pt-3 border-top">
            <div class="d-flex gap-2 justify-content-end">
              <div class="claim-status" 
                   data-notification-id="{{ n.id }}" 
                   data-user-id="{{ session.user_id }}"
                   data-match-id="{{ n.match_id }}"
                   data-is-read="{{ 'True' if n.is_read else 'False' }}">
                <div class="d-flex gap-2">
                  <!-- Buttons will be shown/hidden by JavaScript based on user's role and claim status -->
                  <button class="btn btn-primary-custom btn-sm claim-btn " 
                          data-action="claimed" 
                          data-notification-id="{{ n.id }}"
                          style="display: none;">
                    Mark as Claimed
                  </button>
                  <button class="btn btn-primary-custom btn-sm claim-btn " 
                          data-action="returned" 
                          data-notification-id="{{ n.id }}"
                          style="display: none;">
                    Mark as Returned
                  </button>
                  <!-- Labels for completed actions -->
                  <span class="badge bg-success claimed-label" style="display: none;">
                    âœ“ Claimed
                  </span>
                  <span class="badge bg-info returned-label" style="display: none;">
                    âœ“ Returned
                  </span>
                </div>
                <div class="claim-status-text mt-2" style="display: none;">
                  <small class="text-muted"></small>
                </div>
              </div>
            </div>
          </div>
        {% endif %}
      </div>
    {% else %}
      <div class="list-group-item">
        <p class="text-muted mb-0">No notifications yet.</p>
      </div>
    {% endfor %}
  </div>
</div>

<script>
document.addEventListener('DOMContentLoaded', function() {
    const claimStatuses = document.querySelectorAll('.claim-status');
    
    claimStatuses.forEach(function(statusDiv) {
        const notificationId = statusDiv.dataset.notificationId;
        const currentUserId = parseInt(statusDiv.dataset.userId);
        const matchId = statusDiv.dataset.matchId;
        
        console.log(`Processing notification ${notificationId}, user ${currentUserId}, is_read: ${statusDiv.dataset.isRead}`);
        
        // Get match details and claim status
        Promise.all([
            fetch(`/api/match-details/${matchId}`).then(r => r.json()),
            fetch(`/api/claim-status/${notificationId}`).then(r => r.json())
        ])
        .then(([matchData, claimData]) => {
            if (matchData.success && claimData.success) {
                console.log(`Match data for notification ${notificationId}:`, matchData);
                console.log(`Claim data for notification ${notificationId}:`, claimData);
                
                // Set item IDs on buttons
                const claimedBtn = statusDiv.querySelector('[data-action="claimed"]');
                const returnedBtn = statusDiv.querySelector('[data-action="returned"]');
                
                const isLostOwner = currentUserId === matchData.match.lost_user_id;
                const isFoundOwner = currentUserId === matchData.match.found_user_id;
                
                if (isLostOwner && claimedBtn) {
                    claimedBtn.dataset.itemId = matchData.match.lost_item_id;
                }
                if (isFoundOwner && returnedBtn) {
                    returnedBtn.dataset.itemId = matchData.match.found_item_id;
                }
                
                // Update UI based on current state
                updateClaimUI(statusDiv, claimData.claim_status, currentUserId);
            } else {
                console.error('Failed to load match or claim data:', matchData, claimData);
            }
        })
        .catch(error => {
            console.error('Error fetching data:', error);
        });
    });
    
    // Handle claim button clicks
    document.addEventListener('click', function(e) {
        if (e.target.classList.contains('claim-btn')) {
            e.preventDefault();
            
            const button = e.target;
            const action = button.dataset.action;
            const itemId = button.dataset.itemId;
            const notificationId = button.dataset.notificationId;
            
            if (!itemId) {
                showMessage('Error: Item ID not found. Please refresh the page.', 'error');
                return;
            }
            
            // Disable button during request
            button.disabled = true;
            const originalText = button.textContent;
            button.textContent = action === 'claimed' ? 'Claiming...' : 'Returning...';
            
            fetch('/api/claim', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                },
                body: JSON.stringify({
                    notification_id: notificationId,
                    item_id: itemId,
                    action_type: action
                })
            })
            .then(response => response.json())
            .then(data => {
                if (data.success) {
                    console.log(`Successfully ${action} item. Response:`, data);
                    
                    // Update the UI immediately
                    const statusDiv = button.closest('.claim-status');
                    
                    // Hide button and show appropriate label
                    button.style.display = 'none';
                    if (action === 'claimed') {
                        const claimedLabel = statusDiv.querySelector('.claimed-label');
                        claimedLabel.style.display = 'inline-block';
                    } else {
                        const returnedLabel = statusDiv.querySelector('.returned-label');
                        returnedLabel.style.display = 'inline-block';
                    }
                    
                    // Update notification to "Read" state
                    const notificationItem = button.closest('.list-group-item');
                    notificationItem.classList.remove('list-group-item-warning');
                    const badge = notificationItem.querySelector('.badge');
                    badge.textContent = 'Read';
                    badge.className = 'badge bg-secondary';
                    
                    // Hide "Mark Read" button
                    const markReadBtn = notificationItem.querySelector('.btn-outline-secondary');
                    if (markReadBtn) {
                        markReadBtn.style.display = 'none';
                    }
                    
                    // CRITICAL: Update the data attribute so refresh works correctly
                    statusDiv.dataset.isRead = 'True';
                    
                    showMessage(data.message, 'success');
                    
                    if (data.both_completed) {
                        showMessage('Both parties have confirmed! The item exchange is complete and the match is resolved.', 'info');
                        
                        const statusText = statusDiv.querySelector('.claim-status-text');
                        const statusTextContent = statusText.querySelector('small');
                        statusText.style.display = 'block';
                        statusTextContent.textContent = 'âœ… Exchange completed! Match resolved.';
                        statusTextContent.className = 'text-success';
                    }
                } else {
                    console.error('Claim failed:', data);
                    showMessage(data.errors.join(', '), 'error');
                    // Re-enable button
                    button.disabled = false;
                    button.textContent = originalText;
                }
            })
            .catch(error => {
                console.error('Error:', error);
                showMessage('An error occurred. Please try again.', 'error');
                button.disabled = false;
                button.textContent = originalText;
            });
        }
    });
});

function updateClaimUI(statusDiv, claimStatus, currentUserId) {
    const claimedBtn = statusDiv.querySelector('[data-action="claimed"]');
    const returnedBtn = statusDiv.querySelector('[data-action="returned"]');
    const claimedLabel = statusDiv.querySelector('.claimed-label');
    const returnedLabel = statusDiv.querySelector('.returned-label');
    const statusText = statusDiv.querySelector('.claim-status-text');
    const statusTextContent = statusText.querySelector('small');
    
    // Get current notification read status
    const isRead = statusDiv.dataset.isRead === 'True';
    
    console.log(`UpdateClaimUI for user ${currentUserId}, isRead: ${isRead}`, claimStatus);
    
    // Reset all visibility
    if (claimedBtn) claimedBtn.style.display = 'none';
    if (returnedBtn) returnedBtn.style.display = 'none';
    claimedLabel.style.display = 'none';
    returnedLabel.style.display = 'none';
    statusText.style.display = 'none';
    
    // Check what actions have been taken
    const userClaimed = claimStatus.claimed && claimStatus.claimed.user_id === currentUserId;
    const userReturned = claimStatus.returned && claimStatus.returned.user_id === currentUserId;
    
    if (claimStatus.both_completed) {
        // Both actions completed - show completion message and labels
        statusText.style.display = 'block';
        statusTextContent.textContent = 'âœ… Exchange completed! Match resolved.';
        statusTextContent.className = 'text-success';
        
        if (claimStatus.claimed) claimedLabel.style.display = 'inline-block';
        if (claimStatus.returned) returnedLabel.style.display = 'inline-block';
        
    } else if (userClaimed) {
        // Current user has claimed
        claimedLabel.style.display = 'inline-block';
        console.log(`User ${currentUserId} has claimed - showing claimed label`);
        
    } else if (userReturned) {
        // Current user has returned
        returnedLabel.style.display = 'inline-block';
        console.log(`User ${currentUserId} has returned - showing returned label`);
        
    } else {
        // User hasn't taken action yet
        // Show buttons only if notification is NOT read
        if (!isRead) {
            console.log(`User ${currentUserId} hasn't acted and notification is unread - showing buttons`);
            if (claimedBtn && claimedBtn.dataset.itemId) {
                claimedBtn.style.display = 'inline-block';
            }
            if (returnedBtn && returnedBtn.dataset.itemId) {
                returnedBtn.style.display = 'inline-block';
            }
        } else {
            console.log(`User ${currentUserId} hasn't acted but notification is read - no buttons shown`);
        }
    }
    
    // Show status messages for any completed actions
    let statusMessages = [];
    if (claimStatus.claimed && !claimStatus.both_completed) {
        statusMessages.push(`${claimStatus.claimed.name} marked as claimed`);
    }
    if (claimStatus.returned && !claimStatus.both_completed) {
        statusMessages.push(`${claimStatus.returned.name} marked as returned`);
    }
    
    if (statusMessages.length > 0) {
        statusText.style.display = 'block';
        statusTextContent.textContent = statusMessages.join(', ');
        statusTextContent.className = 'text-info';
    }
}

function showMessage(message, type) {
    const toast = document.createElement('div');
    toast.className = `alert alert-${type === 'error' ? 'danger' : type === 'success' ? 'success' : 'info'} alert-dismissible fade show position-fixed`;
    toast.style.top = '20px';
    toast.style.right = '20px';
    toast.style.zIndex = '9999';
    toast.innerHTML = `
        ${message}
        <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
    `;
    
    document.body.appendChild(toast);
    
    setTimeout(() => {
        if (toast.parentNode) {
            toast.parentNode.removeChild(toast);
        }
    }, 5000);
}
</script>
{% endblock %}