{% extends "base.html" %}
{% block title %}Match Items - Reunited{% endblock %}

{% block content %}
<div class="container-fluid">
  <div class="dashboard-header mb-4">
    <h1 class="fw-bold mb-2">Match Items üïµÔ∏è‚Äç‚ôÇÔ∏è</h1>
    <p class="mb-0 opacity-75">Here are items matched with yours.</p>
  </div>

  <!-- Match Items Grid -->
  <div class="row g-4" id="matchesGrid">
    {% for match in matches %}
    <div class="col-12 col-sm-6 col-lg-4 match-card" 
         style="cursor: pointer;"
         data-bs-toggle="modal" 
         data-bs-target="#matchDetailModal"
         data-lost-title="{{ match.lost_title }}"
         data-lost-description="{{ match.lost_description }}"
         data-lost-category="{{ match.lost_category }}"
         data-lost-date="{{ match.lost_date_reported.strftime('%B %d, %Y at %I:%M %p') if match.lost_date_reported else 'N/A' }}"
         data-lost-image="{{ url_for('static', filename=match.lost_image) if match.lost_image else url_for('static', filename='images/placeholder.png') }}"
         data-lost-reporter="{{ match.lost_first_name }} {{ match.lost_last_name }}"
         data-lost-profile="{{ url_for('static', filename='uploads/profile_pictures/' ~ match.lost_profile) if match.lost_profile else '' }}"
         data-lost-initials="{{ match.lost_first_name[0]|upper }}{{ match.lost_last_name[0]|upper }}"
         data-found-title="{{ match.found_title }}"
         data-found-description="{{ match.found_description }}"
         data-found-category="{{ match.found_category }}"
         data-found-date="{{ match.found_date_reported.strftime('%B %d, %Y at %I:%M %p') if match.found_date_reported else 'N/A' }}"
         data-found-image="{{ url_for('static', filename=match.found_image) if match.found_image else url_for('static', filename='images/placeholder.png') }}"
         data-found-reporter="{{ match.found_first_name }} {{ match.found_last_name }}"
         data-found-profile="{{ url_for('static', filename='uploads/profile_pictures/' ~ match.found_profile) if match.found_profile else '' }}"
         data-found-initials="{{ match.found_first_name[0]|upper }}{{ match.found_last_name[0]|upper }}"
         data-match-score="{{ match.match_score }}"
         data-match-date="{{ match.match_at.strftime('%B %d, %Y at %I:%M %p') if match.match_at else 'N/A' }}">
      
      <div class="card shadow-sm h-100" style="min-height: 400px;">
        
        <!-- Images side by side -->
        <div class="d-flex" style="height:200px; overflow:hidden;">
          <img src="{{ url_for('static', filename=match.lost_image) if match.lost_image else url_for('static', filename='images/placeholder.png') }}" 
               class="w-50 border-end object-fit-cover" alt="Lost Item Image">
          <img src="{{ url_for('static', filename=match.found_image) if match.found_image else url_for('static', filename='images/placeholder.png') }}" 
               class="w-50 object-fit-cover" alt="Found Item Image">
        </div>

        <div class="card-body">
          <h5 class="card-title">
            {{ match.lost_title }} ‚Üî {{ match.found_title }}
          </h5>
          <p class="card-text small text-muted">
            Matched on: {{ match.match_at.strftime('%b %d, %Y') if match.match_at else 'N/A' }}
          </p>
          <p class="card-text">
            <b>Lost:</b> {{ match.lost_description[:50] }}{{ '...' if match.lost_description|length > 50 else '' }} <br>
            <b>Found:</b> {{ match.found_description[:50] }}{{ '...' if match.found_description|length > 50 else '' }}
          </p>

          <!-- Match confidence -->
          {% set score = match.match_score %}
          {% if score >= 1 %}
            <span class="badge bg-success">‚úÖ Exact Match ({{ score }})</span>
          {% elif score >= 0.8 %}
            <span class="badge bg-success">Very High Possibility ({{ score }})</span>
          {% elif score >= 0.6 %}
            <span class="badge bg-success text-dark">High Possibility ({{ score }})</span>
          {% elif score >= 0.4 %}
            <span class="badge bg-warning">Medium Possibility ({{ score }})</span>
          {% else %}
            <span class="badge bg-secondary">Below Threshold ({{ score }})</span>
          {% endif %}
        </div>

        <div class="card-footer d-flex justify-content-between align-items-center">
          <!-- Lost User -->
          <div class="d-flex align-items-center">
            <div class="user-avatar me-2">
              {% if match.lost_profile %}
                <img src="{{ url_for('static', filename='uploads/profile_pictures/' ~ match.lost_profile) }}" alt="Lost User">
              {% else %}
                {{ match.lost_first_name[0]|upper }}{{ match.lost_last_name[0]|upper }}
              {% endif %}
            </div>
            <small class="text-muted">{{ match.lost_first_name }} {{ match.lost_last_name }}</small>
          </div>

          <!-- Found User -->
          <div class="d-flex align-items-center">
            <div class="user-avatar me-2">
              {% if match.found_profile %}
                <img src="{{ url_for('static', filename='uploads/profile_pictures/' ~ match.found_profile) }}" alt="Found User">
              {% else %}
                {{ match.found_first_name[0]|upper }}{{ match.found_last_name[0]|upper }}
              {% endif %}
            </div>
            <small class="text-muted">{{ match.found_first_name }} {{ match.found_last_name }}</small>
          </div>
        </div>
      </div>
    </div>
    {% else %}
    <div class="col-12">
      <div class="text-center py-5">
        <div class="recent-activity">
          <i class="fas fa-link fa-4x text-black-50 mb-3"></i>
          <h3 class="text-black mb-3">No matches found yet.</h3>
          <p class="text-muted">Matches will appear here when lost and found items are connected.</p>
        </div>
      </div>
    </div>
    {% endfor %}
  </div>
</div>

<!-- Match Detail Modal -->
<div class="modal fade" id="matchDetailModal" tabindex="-1" aria-labelledby="matchDetailModalLabel" aria-hidden="true">
  <div class="modal-dialog modal-xl modal-dialog-centered">
    <div class="modal-content">
      <div class="modal-header">
        <h5 class="modal-title" id="matchDetailModalLabel">Match Details</h5>
       
      </div>
      <div class="modal-body">
        <!-- Match Score Banner -->
        <div class="text-center mb-4">
          <h4 class="mb-2">Match Confidence</h4>
          <span id="modalMatchScore" class="badge fs-5"></span>
          <p class="text-muted small mt-2">Matched on <span id="modalMatchDate"></span></p>
        </div>

        <div class="row">
          <!-- Lost Item Column -->
          <div class="col-md-6 border-end">
            <div class="text-center mb-3">
              <h5 class="text-danger fw-bold">
                <i class="fas fa-search me-2"></i>LOST ITEM
              </h5>
            </div>
            
            <div class="mb-3">
              <img id="modalLostImage" src="" alt="Lost Item Image" 
                   class="img-fluid rounded shadow-sm w-100" 
                   style="max-height: 300px; object-fit: contain; background-color: #f8f9fa;">
            </div>
            
            <div class="mb-3">
              <h5 id="modalLostTitle" class="fw-bold text-primary"></h5>
            </div>
            
            <div class="mb-3">
              <h6 class="text-muted mb-1">Category</h6>
              <p id="modalLostCategory" class="mb-0"></p>
            </div>
            
            <div class="mb-3">
              <h6 class="text-muted mb-1">Description</h6>
              <p id="modalLostDescription" class="mb-0"></p>
            </div>
            
            <div class="mb-3">
              <h6 class="text-muted mb-1">Date Reported</h6>
              <p id="modalLostDate" class="mb-0"></p>
            </div>
            
            <div class="border-top pt-3">
              <h6 class="text-muted mb-2">Reported By</h6>
              <div class="d-flex align-items-center">
                <div class="user-avatar me-3" id="modalLostAvatar"></div>
                <div>
                  <p id="modalLostReporter" class="mb-0 fw-semibold"></p>
                  <small class="text-muted">Lost Item Reporter</small>
                </div>
              </div>
            </div>
          </div>

          <!-- Found Item Column -->
          <div class="col-md-6">
            <div class="text-center mb-3">
              <h5 class="text-success fw-bold">
                <i class="fas fa-check-circle me-2"></i>FOUND ITEM
              </h5>
            </div>
            
            <div class="mb-3">
              <img id="modalFoundImage" src="" alt="Found Item Image" 
                   class="img-fluid rounded shadow-sm w-100" 
                   style="max-height: 300px; object-fit: contain; background-color: #f8f9fa;">
            </div>
            
            <div class="mb-3">
              <h5 id="modalFoundTitle" class="fw-bold text-primary"></h5>
            </div>
            
            <div class="mb-3">
              <h6 class="text-muted mb-1">Category</h6>
              <p id="modalFoundCategory" class="mb-0"></p>
            </div>
            
            <div class="mb-3">
              <h6 class="text-muted mb-1">Description</h6>
              <p id="modalFoundDescription" class="mb-0"></p>
            </div>
            
            <div class="mb-3">
              <h6 class="text-muted mb-1">Date Reported</h6>
              <p id="modalFoundDate" class="mb-0"></p>
            </div>
            
            <div class="border-top pt-3">
              <h6 class="text-muted mb-2">Reported By</h6>
              <div class="d-flex align-items-center">
                <div class="user-avatar me-3" id="modalFoundAvatar"></div>
                <div>
                  <p id="modalFoundReporter" class="mb-0 fw-semibold"></p>
                  <small class="text-muted">Found Item Reporter</small>
                </div>
              </div>
            </div>
          </div>
        </div>
      </div>
      
      <div class="modal-footer">
        <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Close</button>
      </div>
    </div>
  </div>
</div>

<script>
document.addEventListener('DOMContentLoaded', function() {
  const matchDetailModal = document.getElementById('matchDetailModal');
  
  matchDetailModal.addEventListener('show.bs.modal', function (event) {
    const button = event.relatedTarget;
    
    // Get match data from the clicked card
    const matchScore = parseFloat(button.dataset.matchScore);
    const matchDate = button.dataset.matchDate;
    
    // Lost item data
    const lostTitle = button.dataset.lostTitle;
    const lostDescription = button.dataset.lostDescription;
    const lostCategory = button.dataset.lostCategory;
    const lostDate = button.dataset.lostDate;
    const lostImage = button.dataset.lostImage;
    const lostReporter = button.dataset.lostReporter;
    const lostProfile = button.dataset.lostProfile;
    const lostInitials = button.dataset.lostInitials;
    
    // Found item data
    const foundTitle = button.dataset.foundTitle;
    const foundDescription = button.dataset.foundDescription;
    const foundCategory = button.dataset.foundCategory;
    const foundDate = button.dataset.foundDate;
    const foundImage = button.dataset.foundImage;
    const foundReporter = button.dataset.foundReporter;
    const foundProfile = button.dataset.foundProfile;
    const foundInitials = button.dataset.foundInitials;
    
    // Populate match score
    const scoreBadge = document.getElementById('modalMatchScore');
    if (matchScore >= 1) {
      scoreBadge.textContent = `‚úÖ Exact Match (${matchScore})`;
      scoreBadge.className = 'badge bg-success fs-5';
    } else if (matchScore >= 0.8) {
      scoreBadge.textContent = `Very High Possibility (${matchScore})`;
      scoreBadge.className = 'badge bg-success fs-5';
    } else if (matchScore >= 0.6) {
      scoreBadge.textContent = `High Possibility (${matchScore})`;
      scoreBadge.className = 'badge bg-info fs-5';
    } else if (matchScore >= 0.4) {
      scoreBadge.textContent = `Medium Possibility (${matchScore})`;
      scoreBadge.className = 'badge bg-warning fs-5';
    } else {
      scoreBadge.textContent = `Below Threshold (${matchScore})`;
      scoreBadge.className = 'badge bg-secondary fs-5';
    }
    
    document.getElementById('modalMatchDate').textContent = matchDate;
    
    // Populate lost item details
    document.getElementById('modalLostTitle').textContent = lostTitle;
    document.getElementById('modalLostDescription').textContent = lostDescription;
    document.getElementById('modalLostCategory').textContent = lostCategory;
    document.getElementById('modalLostDate').textContent = lostDate;
    document.getElementById('modalLostImage').src = lostImage;
    document.getElementById('modalLostReporter').textContent = lostReporter;
    
    // Set lost reporter avatar
    const lostAvatar = document.getElementById('modalLostAvatar');
    if (lostProfile) {
      lostAvatar.innerHTML = `<img src="${lostProfile}" alt="Profile Picture" style="width: 50px; height: 50px; border-radius: 50%; object-fit: cover;">`;
    } else {
      lostAvatar.innerHTML = `<div style="width: 50px; height: 50px; border-radius: 50%; background-color: var(--primary-color); color: white; display: flex; align-items: center; justify-content: center; font-weight: bold;">${lostInitials}</div>`;
    }
    
    // Populate found item details
    document.getElementById('modalFoundTitle').textContent = foundTitle;
    document.getElementById('modalFoundDescription').textContent = foundDescription;
    document.getElementById('modalFoundCategory').textContent = foundCategory;
    document.getElementById('modalFoundDate').textContent = foundDate;
    document.getElementById('modalFoundImage').src = foundImage;
    document.getElementById('modalFoundReporter').textContent = foundReporter;
    
    // Set found reporter avatar
    const foundAvatar = document.getElementById('modalFoundAvatar');
    if (foundProfile) {
      foundAvatar.innerHTML = `<img src="${foundProfile}" alt="Profile Picture" style="width: 50px; height: 50px; border-radius: 50%; object-fit: cover;">`;
    } else {
      foundAvatar.innerHTML = `<div style="width: 50px; height: 50px; border-radius: 50%; background-color: var(--primary-color); color: white; display: flex; align-items: center; justify-content: center; font-weight: bold;">${foundInitials}</div>`;
    }
  });
});
</script>
{% endblock %}