{% extends "base.html" %}
{% block title %}My Posted Items - Reunited{% endblock %}

{% block head %}
<link href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.0/font/bootstrap-icons.css" rel="stylesheet">
<style>
  .payment-method-card { transition: all 0.3s; }
  .payment-method-card.active { border-color: #0d6efd; background: #f8f9ff; }
  .spinner-border-sm { width: 1.2rem; height: 1.2rem; }
  #paymentItemTitle { max-width: 300px; margin: 0 auto; }
  
  /* Table styling */
  .table-responsive {
    border-radius: 8px;
    overflow: hidden;
  }
  
  .table th {
    background-color: #f8f9fa;
    font-weight: 600;
    border: 1px solid #dee2e6;
  }
  
  .table td {
    border: 1px solid #dee2e6;
  }
  
  .btn-group-sm > .btn {
    padding: 0.25rem 0.5rem;
    font-size: 0.875rem;
    margin: 0 2px;
  }

  /* PayMongo Form Styling */
  .paymongo-form-container {
    min-height: 200px;
    display: flex;
    align-items: center;
    justify-content: center;
  }
  
  .paymongo-form-container.loading {
    background: #f8f9fa;
    border-radius: 8px;
  }
</style>
{% endblock %}

{% block content %}
<div class="container-fluid">
  <div class="dashboard-header mb-4">
    <div class="d-flex flex-column flex-md-row justify-content-between align-items-md-center gap-3 border-1">
      <div class="text-center text-md-start">
        <h1 class="fw-bold mb-2">My Posted Items üìã</h1>
        <p class="mb-0 opacity-75">Manage your lost and found items.</p>
      </div>
    </div>
  </div>

  <div class="recent-activity mb-4">
    <div class="row g-3">
      <div class="col-12 col-md-8">
        <div class="position-relative">
          <i class="fas fa-search position-absolute top-50 start-0 translate-middle-y ms-3 text-black-50"></i>
          <input type="text" id="searchInput" 
                 class="form-control ps-5"
                 placeholder="Search your items...">
        </div>
      </div>
      <div class="col-6 col-md-2">
        <select id="typeFilter" class="form-select">
          <option value="">All Types</option>
          <option value="lost">Lost Items</option>
          <option value="found">Found Items</option>
        </select>
      </div>
      <div class="col-6 col-md-2">
        <select id="statusFilter" class="form-select">
          <option value="">All Status</option>
          <option value="claimed">Claimed</option>
          <option value="returned">Returned</option>
          <option value="not yet found">Not Yet Found</option>
          <option value="unclaimed">Unclaimed</option>
        </select>
      </div>
    </div>
  </div>

  <!-- Items Table -->
  {% if posted_items %}
  <div class="table-responsive w-100">
    <table class="table table-hover mb-0 w-100" id="postedItemsTable">
      <thead class="table-light">
        <tr>
          <th style="width: 25%;">Item</th>
          <th style="width: 8%;">Type</th>
          <th style="width: 10%;">Category</th>
          <th style="width: 10%;">Status</th>
          <th style="width: 10%;">Payment</th>
          <th style="width: 10%;">Reward</th>
          <th style="width: 10%;">Date Posted</th>
          <th style="width: 7%;">Matches</th>
          <th style="width: 10%;">Actions</th>
        </tr>
      </thead>
      <tbody>
        {% for item in posted_items %}
        <tr class="item-row"
            data-title="{{ item.title|lower }}" 
            data-description="{{ item.description|lower }}" 
            data-type="{{ item.type|lower }}" 
            data-status="{{ (item.status or 'active')|lower }}"
            data-item-id="{{ item.id }}">
          <td>
            <div class="d-flex align-items-center">
              {% if item.image_path %}
              <img src="{{ url_for('uploaded_item_file', filename=item.image_path.split('/')[-1]) }}" 
                   class="rounded me-3" style="width: 50px; height: 50px; object-fit: cover;">
              {% else %}
              <div class="bg-light rounded d-flex align-items-center justify-content-center me-3" 
                   style="width: 50px; height: 50px;">
                <i class="bi bi-image text-muted"></i>
              </div>
              {% endif %}
              <div>
                <h6 class="mb-1 item-title">{{ item.title }}</h6>
                <small class="text-muted item-description">{{ item.description[:50] }}{% if item.description|length > 50 %}...{% endif %}</small>
              </div>
            </div>
          </td>
          <td class="item-type">{{ item.type.title() }}</td>
          <td class="item-category">{{ item.category or 'Not specified' }}</td>
          <td class="item-status">{{ item.status or 'Active' }}</td>
          <td class="payment-status">
            {% if item.type == 'lost' %}
              {% if item.payment_status == 'paid' %}
                <span class="badge bg-success">Paid</span>
              {% elif item.payment_status == 'failed' %}
                <span class="badge bg-danger">Failed</span>
              {% else %}
                <span class="badge bg-warning">Pending</span>
              {% endif %}
            {% else %}
              <span class="badge bg-secondary">Free</span>
            {% endif %}
          </td>
          <td class="item-reward">
            {% if item.reward and item.reward.strip() and item.reward != 'No Reward' %}
              {{ item.reward }}
            {% else %}
              No Reward
            {% endif %}
          </td>
          <td class="item-date">{{ item.created_at.strftime('%b %d, %Y') }}</td>
          <td class="item-matches text-center">{{ item.match_count or 0 }}</td>
          <td>
            <div class="d-flex justify-content-center">
              <div class="btn-group btn-group-sm">
                {% if item.type == 'lost' and item.payment_status != 'paid' %}
                <button class="btn btn-outline-success pay-btn" 
                        data-item-id="{{ item.id }}"
                        data-item-title="{{ item.title }}"
                        data-bs-toggle="tooltip" title="Pay ‚Ç±20">
                  <i class="bi bi-credit-card"></i> 
                </button>
                {% endif %}
                <button class="btn btn-outline-primary edit-btn" 
                        data-item-id="{{ item.id }}"
                        data-item-type="{{ item.type }}"
                        data-bs-toggle="tooltip" title="Edit">
                  <i class="bi bi-pencil"></i>
                </button>
                <button class="btn btn-outline-danger delete-btn" 
                        data-item-id="{{ item.id }}"
                        data-bs-toggle="tooltip" title="Delete">
                  <i class="bi bi-trash"></i>
                </button>
              </div>
            </div>
          </td>
        </tr>
        {% endfor %}
      </tbody>
    </table>
  </div>
  {% else %}
  <div class="text-center py-5">
    <div class="recent-activity">
      <i class="bi bi-inbox fa-4x text-black-50 mb-3"></i>
      <h3 class="text-black mb-3">No items posted yet.</h3>
      <a href="{{ url_for('dashboard') }}" class="btn btn-primary-custom">
        <i class="fas fa-plus me-2"></i>Post Your First Item
      </a>
    </div>
  </div>
  {% endif %}

  <div id="noResults" class="col-12 text-center py-5" style="display: none;">
    <div class="recent-activity">
      <i class="fas fa-search fa-3x text-black-50 mb-3"></i>
      <h4 class="text-black">No items found</h4>
      <p class="text-muted">Try adjusting your search criteria.</p>
    </div>
  </div>
</div>

<!-- Payment Modal with Real PayMongo Integration -->
<div class="modal fade" id="paymentModal" tabindex="-1" aria-labelledby="paymentModalLabel" aria-hidden="true">
  <div class="modal-dialog modal-lg">
    <div class="modal-content">
      <div class="modal-header border-0">
        <h5 class="modal-title fw-bold" id="paymentModalLabel">Complete Payment ‚Äî ‚Ç±20.00</h5>
        <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
      </div>
      <div class="modal-body">
        <!-- Item being paid for -->
        <div class="text-center mb-4">
          <h6 class="text-muted">You're paying for:</h6>
          <p class="fw-bold fs-5 text-truncate" id="paymentItemTitle">Loading...</p>
        </div>

        <!-- PayMongo Payment Form Container -->
        <div class="paymongo-form-container loading" id="paymongoFormContainer">
          <div class="text-center">
            <div class="spinner-border text-primary mb-3" role="status">
              <span class="visually-hidden">Loading payment form...</span>
            </div>
            <p>Loading payment form...</p>
          </div>
        </div>

        <!-- Payment Status Messages -->
        <div id="paymentSuccess" style="display: none;">
          <div class="text-center text-success py-4">
            <i class="fas fa-check-circle fa-3x mb-3"></i>
            <h5>Payment Successful!</h5>
            <p>Your lost item is now visible to everyone.</p>
            <button class="btn btn-success mt-2" onclick="location.reload()">Refresh Page</button>
          </div>
        </div>

        <div id="paymentError" style="display: none;">
          <div class="text-center text-danger py-4">
            <i class="fas fa-times-circle fa-3x mb-3"></i>
            <h5>Payment Failed</h5>
            <p id="errorMessage">Please try again.</p>
            <button class="btn btn-outline-secondary mt-2" onclick="resetPaymentForm()">Try Again</button>
          </div>
        </div>

      
      </div>
    </div>
  </div>
</div>

<!-- Edit Item Modal (keep your existing one) -->
<div class="modal fade" id="editItemModal" tabindex="-1" aria-labelledby="editItemModalLabel" aria-hidden="true">
  <!-- Your existing edit modal content remains the same -->
  <div class="modal-dialog modal-lg">
    <div class="modal-content">
      <form id="editItemForm">
        <div class="modal-header">
          <h5 class="modal-title fw-bold" id="editItemModalLabel">Edit Item</h5>
          <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
        </div>
        <div class="modal-body">
          <input type="hidden" id="editItemId">
          <input type="hidden" id="editItemType">
          <div class="mb-3">
            <label class="form-label">Item Title</label>
            <input type="text" id="editItemTitle" name="title" class="form-control" required>
          </div>
          <div class="mb-3">
            <label class="form-label">Category</label>
            <select id="editItemCategory" name="category" class="form-select" required>
              <option value="">Select category</option>
              <option value="Electronics">Electronics</option>
              <option value="Wallet">Wallet</option>
              <option value="Keys">Keys</option>
              <option value="Phone">Phone</option>
              <option value="Laptop/Tablet">Laptop/Tablet</option>
              <option value="Bag/Backpack">Bag/Backpack</option>
              <option value="Clothing">Clothing</option>
              <option value="Jewelry">Jewelry</option>
              <option value="Documents">Documents</option>
              <option value="Books">Books</option>
              <option value="Glasses">Glasses</option>
              <option value="Sports Equipment">Sports Equipment</option>
              <option value="Pet Items">Pet Items</option>
              <option value="Other">Other</option>
            </select>
          </div>
          <div class="mb-3">
            <label class="form-label">Description</label>
            <textarea id="editItemDescription" name="description" class="form-control" rows="3" required></textarea>
          </div>
          <div class="mb-3">
            <label class="form-label">Location</label>
            <input type="text" id="editItemLocation" name="location_reported" class="form-control" required>
          </div>
          <div class="mb-3" id="editRewardSection">
            <label class="form-label">Reward (Optional)</label>
            <input type="text" id="editItemReward" name="reward" class="form-control" placeholder="Enter reward amount or description">
          </div>
        </div>
        <div class="modal-footer">
          <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
          <button type="submit" class="btn btn-primary">Update Item</button>
        </div>
      </form>
    </div>
  </div>
</div>

<!-- Load PayMongo.js -->
<script>
// ========== FIXED PAYMONGO PAYMENT FLOW ==========
let currentPaymentItemId = null;

document.addEventListener('DOMContentLoaded', function() {
    console.log('Posted items page loaded');
    
    // Your existing search/filter functionality
    const searchInput = document.getElementById('searchInput');
    const typeFilter = document.getElementById('typeFilter');
    const statusFilter = document.getElementById('statusFilter');
    const noResults = document.getElementById('noResults');

    function filterItems() {
        const searchTerm = searchInput.value.toLowerCase();
        const selectedType = typeFilter.value.toLowerCase();
        const selectedStatus = statusFilter.value.toLowerCase();

        const rows = document.querySelectorAll('.item-row');
        let visibleCount = 0;

        rows.forEach(row => {
            const title = row.dataset.title;
            const description = row.dataset.description;
            const type = row.dataset.type;
            const status = row.dataset.status;

            const matchesSearch = !searchTerm || title.includes(searchTerm) || description.includes(searchTerm);
            const matchesType = !selectedType || type === selectedType;
            const matchesStatus = !selectedStatus || status.includes(selectedStatus);

            if (matchesSearch && matchesType && matchesStatus) {
                row.style.display = '';
                visibleCount++;
            } else {
                row.style.display = 'none';
            }
        });

        noResults.style.display = visibleCount === 0 ? 'block' : 'none';
    }

    if (searchInput) searchInput.addEventListener('input', filterItems);
    if (typeFilter) typeFilter.addEventListener('change', filterItems);
    if (statusFilter) statusFilter.addEventListener('change', filterItems);

    // Initialize tooltips
    const tooltipTriggerList = document.querySelectorAll('[data-bs-toggle="tooltip"]');
    if (tooltipTriggerList.length > 0) {
        [...tooltipTriggerList].map(el => new bootstrap.Tooltip(el));
    }

    // Event delegation for buttons
    document.addEventListener('click', function(event) {
        // Handle Pay button - SIMPLIFIED FLOW
        if (event.target.closest('.pay-btn')) {
            const button = event.target.closest('.pay-btn');
            const itemId = button.getAttribute('data-item-id');
            const itemTitle = button.getAttribute('data-item-title');
            
            console.log('üí≥ Pay button clicked for item:', itemId);
            initiatePayment(itemId, itemTitle);
        }
        
        // Handle Edit button
        if (event.target.closest('.edit-btn')) {
            const button = event.target.closest('.edit-btn');
            const itemId = button.getAttribute('data-item-id');
            const itemType = button.getAttribute('data-item-type');
            editItem(itemId, itemType);
        }
        
        // Handle Delete button
        if (event.target.closest('.delete-btn')) {
            const button = event.target.closest('.delete-btn');
            const itemId = button.getAttribute('data-item-id');
            deleteItem(itemId);
        }
    });

    // Edit form submission
    const editForm = document.getElementById('editItemForm');
    if (editForm) {
        editForm.addEventListener('submit', function(e) {
            e.preventDefault();
            handleEditFormSubmit();
        });
    }
});

// ========== SIMPLIFIED PAYMONGO PAYMENT FLOW ==========

// ========== PAYMENT FLOW WITH DEBUGGING ==========

async function initiatePayment(itemId, itemTitle) {
    currentPaymentItemId = itemId;
    
    // Show payment modal with loading state
    const paymentModal = new bootstrap.Modal(document.getElementById('paymentModal'));
    document.getElementById('paymentItemTitle').textContent = itemTitle;
    
    const formContainer = document.getElementById('paymongoFormContainer');
    formContainer.className = 'paymongo-form-container loading';
    formContainer.innerHTML = `
        <div class="text-center">
            <div class="spinner-border text-primary mb-3" role="status">
                <span class="visually-hidden">Preparing payment...</span>
            </div>
            <h5>Setting up secure payment...</h5>
            <p class="text-muted">Please wait a moment</p>
        </div>
    `;
    
    document.getElementById('paymentSuccess').style.display = 'none';
    document.getElementById('paymentError').style.display = 'none';
    
    paymentModal.show();

    try {
        console.log('üì° Creating checkout session for item:', itemId);
        
        const response = await fetch(`/api/initiate-payment/${itemId}`, {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
            }
        });
        
        console.log('üì° Response status:', response.status);
        
        // Parse the JSON response
        const result = await response.json();
        console.log('üì° Response data:', result);
        
        if (!result.success) {
            throw new Error(result.errors?.[0] || 'Failed to create checkout session');
        }
        
        // Validate that we have the required data
        if (!result.checkout_url || !result.session_id) {
            console.error('‚ùå Missing required fields in response:', result);
            throw new Error('Invalid response from server - missing checkout URL or session ID');
        }
        
        console.log('‚úÖ Checkout session created successfully');
        console.log('‚úÖ Session ID:', result.session_id);
        console.log('‚úÖ Checkout URL:', result.checkout_url);
        
        // Show redirect button
        formContainer.className = 'paymongo-form-container';
        formContainer.innerHTML = `
            <div class="text-center py-4">
                <i class="fas fa-credit-card fa-3x text-primary mb-3"></i>
                <h5 class="mb-3">Ready to Pay</h5>
                <p class="text-muted mb-4">You'll be redirected to PayMongo's secure checkout page</p>
                <button class="btn btn-primary btn-lg" onclick="proceedToCheckout('${result.checkout_url}')">
                    <i class="fas fa-lock me-2"></i>Proceed to Secure Payment
                </button>
                <p class="text-muted mt-3 small">
                    <i class="fas fa-shield-alt me-1"></i>
                    Secured by PayMongo
                </p>
            </div>
        `;
        
    } catch (error) {
        console.error('‚ùå Payment initiation failed:', error);
        showPaymentError(error.message || 'An unexpected error occurred');
    }
}

// Redirect to PayMongo checkout
function proceedToCheckout(checkoutUrl) {
    console.log('üîó Redirecting to PayMongo checkout:', checkoutUrl);
    
    // Validate URL before redirecting
    if (!checkoutUrl || checkoutUrl === 'undefined' || checkoutUrl.includes('undefined')) {
        console.error('‚ùå Invalid checkout URL:', checkoutUrl);
        showPaymentError('Invalid checkout URL received. Please try again.');
        return;
    }
    
    window.location.href = checkoutUrl;
}

// ========== EXISTING FUNCTIONS (Edit/Delete) ==========

async function editItem(itemId, itemType) {
    try {
        console.log('Fetching item details for:', itemId, 'Type:', itemType);
        
        const response = await fetch(`/api/get-item/${itemId}`);
        const data = await response.json();

        if (data.success && data.item) {
            const item = data.item;
            
            document.getElementById('editItemId').value = itemId;
            document.getElementById('editItemType').value = itemType;
            document.getElementById('editItemTitle').value = item.title || '';
            document.getElementById('editItemCategory').value = item.category || '';
            document.getElementById('editItemDescription').value = item.description || '';
            document.getElementById('editItemLocation').value = item.location_reported || '';
            document.getElementById('editItemReward').value = item.reward || '';
            
            const rewardSection = document.getElementById('editRewardSection');
            if (itemType === 'found') {
                rewardSection.style.display = 'none';
            } else {
                rewardSection.style.display = 'block';
            }
            
            const editModal = new bootstrap.Modal(document.getElementById('editItemModal'));
            editModal.show();
            
        } else {
            showAlert(data.errors ? data.errors[0] : 'Failed to load item details', 'danger');
        }
        
    } catch (error) {
        console.error('Error in editItem function:', error);
        showAlert('Error loading item details. Please try again.', 'danger');
    }
}

function deleteItem(itemId) {
    if (confirm('Are you sure you want to delete this item? This action cannot be undone.')) {
        fetch(`/api/delete-item/${itemId}`, {
            method: 'DELETE',
            headers: {
                'Content-Type': 'application/json'
            }
        })
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                showAlert('Item deleted successfully!', 'success');
                setTimeout(() => window.location.reload(), 1500);
            } else {
                showAlert(data.errors[0], 'danger');
            }
        })
        .catch(error => {
            showAlert('Error deleting item', 'danger');
        });
    }
}

function handleEditFormSubmit() {
    const itemId = document.getElementById('editItemId').value;
    const itemType = document.getElementById('editItemType').value;
    const formData = {
        title: document.getElementById('editItemTitle').value,
        category: document.getElementById('editItemCategory').value,
        description: document.getElementById('editItemDescription').value,
        location_reported: document.getElementById('editItemLocation').value
    };
    
    if (itemType === 'lost') {
        formData.reward = document.getElementById('editItemReward').value || '';
    }
    
    fetch(`/api/update-item/${itemId}`, {
        method: 'PUT',
        headers: {
            'Content-Type': 'application/json'
        },
        body: JSON.stringify(formData)
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            showAlert('Item updated successfully!', 'success');
            const editModal = bootstrap.Modal.getInstance(document.getElementById('editItemModal'));
            if (editModal) editModal.hide();
            setTimeout(() => window.location.reload(), 1500);
        } else {
            showAlert(data.errors[0], 'danger');
        }
    })
    .catch(error => {
        showAlert('Error updating item', 'danger');
    });
}

function showAlert(message, type) {
    const existingAlerts = document.querySelectorAll('.alert');
    existingAlerts.forEach(alert => alert.remove());
    
    const alertDiv = document.createElement('div');
    alertDiv.className = `alert alert-${type} alert-dismissible fade show`;
    alertDiv.innerHTML = `
        ${message}
        <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
    `;
    
    const container = document.querySelector('.container-fluid');
    if (container) {
        const dashboardHeader = container.querySelector('.dashboard-header');
        if (dashboardHeader) {
            container.insertBefore(alertDiv, dashboardHeader);
        } else {
            container.prepend(alertDiv);
        }
    }
    
    setTimeout(() => {
        if (alertDiv.parentElement) {
            alertDiv.remove();
        }
    }, 5000);
}
</script>
{% endblock %}