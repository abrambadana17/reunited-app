{% extends "adminbase.html" %}

{% block title %}Admin Dashboard - Reunited{% endblock %}

{% block page_title %}Admin Dashboard{% endblock %}
{% block page_subtitle %}Manage Reunited Platform{% endblock %}

{% block content %}
<!-- Stats Overview -->
<div class="row g-3 mb-4">
  <div class="col-12 col-md-6 col-lg-3">
    <div class="stats-card">
      <div class="stats-icon bg-primary bg-opacity-10 text-primary">
        <i class="fas fa-users"></i>
      </div>
      <h2 class="stats-number text-primary" id="totalUsers">0</h2>
      <p class="mb-0 text-muted">Total Users</p>
    </div>
  </div>
  <div class="col-12 col-md-6 col-lg-3">
    <div class="stats-card">
      <div class="stats-icon bg-success bg-opacity-10 text-success">
        <i class="fas fa-box"></i>
      </div>
      <h2 class="stats-number text-success" id="totalItems">0</h2>
      <p class="mb-0 text-muted">Total Items</p>
    </div>
  </div>
  <div class="col-12 col-md-6 col-lg-3">
    <div class="stats-card">
      <div class="stats-icon bg-info bg-opacity-10 text-info">
        <i class="fas fa-link"></i>
      </div>
      <h2 class="stats-number text-info" id="totalMatches">0</h2>
      <p class="mb-0 text-muted">Successful Matches</p>
    </div>
  </div>
  <div class="col-12 col-md-6 col-lg-3">
    <div class="stats-card">
      <div class="stats-icon bg-warning bg-opacity-10 text-warning">
        <i class="fas fa-money-bill-wave"></i>
      </div>
      <h2 class="stats-number text-warning" id="totalRevenue">‚Ç±0</h2>
      <p class="mb-0 text-muted">Total Revenue</p>
    </div>
  </div>
</div>

<!-- Charts and Analytics Section -->
<div class="row g-3 mb-4">
  <!-- Monthly Items by Category Chart -->
  <div class="col-12 col-lg-8">
    <div class="chart-container">
      <div class="d-flex justify-content-between align-items-center mb-3">
        <h5 class="mb-0 fw-semibold text-gray-700">
          <i class="fas fa-chart-bar me-2 text-primary"></i>Monthly Items by Category
        </h5>
        <div class="d-flex gap-2">
          <!-- Change this select dropdown -->
          <select class="form-select form-select-sm w-auto" id="categoryChartPeriod">
              <option value="all_time" selected>All Time</option>
              <option value="current_month">This Month</option>
              <option value="last_month">Last Month</option>
          </select>
          <button class="btn btn-sm btn-outline-admin" onclick="loadCategoryChartData()">
            <i class="fas fa-sync-alt"></i>
          </button>
        </div>
      </div>
      <canvas id="monthlyChart" height="250"></canvas>
    </div>
  </div>

  <!-- Recent Platform Activity -->
  <div class="col-12 col-lg-4">
    <div class="chart-container">
      <h5 class="mb-3 fw-semibold text-gray-700">
        <i class="fas fa-clock me-2 text-primary"></i>Recent Platform Activity
      </h5>
      <div id="recentActivity" class="recent-activity-container">
        <div class="text-center py-4">
          <div class="spinner-border text-primary mb-3" role="status">
            <span class="visually-hidden">Loading...</span>
          </div>
          <p class="text-muted mb-0">Loading recent activity...</p>
        </div>
      </div>
    </div>
  </div>
</div>

<style>
  /* Your Theme Variables */
  :root {
    --color-primary: #1E3A8A;
    --color-primary-hover: #1e40af;
    --color-accent: #3B82F6;
    --color-success: #10B981;
    --color-danger: #EF4444;
    --color-warning: #facc15;
    --color-info: #1E3A8A;
    --color-white: #ffffff;
    --color-bg-light: #F8F9FA;
    --color-gray-50: #f9fafb;
    --color-gray-100: #f3f4f6;
    --color-gray-200: #e5e7eb;
    --color-gray-300: #d1d5db;
    --color-gray-400: #94a3b8;
    --color-gray-500: #6b7280;
    --color-gray-700: #374151;
    --color-gray-800: #1f2937;
    --color-gray-900: #111827;
    --shadow-sm: 0 1px 3px rgba(0, 0, 0, 0.1);
    --shadow-md: 0 2px 6px rgba(0, 0, 0, 0.15);
    --shadow-lg: 0 4px 12px rgba(0, 0, 0, 0.15);
    --border-light: 1px solid var(--color-gray-200);
    --radius-md: 8px;
    --radius-lg: 12px;
  }

  .stats-card {
    background: var(--color-white);
    border-radius: var(--radius-lg);
    padding: 1.5rem;
    box-shadow: var(--shadow-sm);
    border: var(--border-light);
    transition: all 0.3s ease;
    height: 100%;
  }

  .stats-card:hover {
    transform: translateY(-2px);
    box-shadow: var(--shadow-md);
  }

  .stats-icon {
    width: 60px;
    height: 60px;
    border-radius: var(--radius-md);
    display: flex;
    align-items: center;
    justify-content: center;
    font-size: 1.5rem;
    margin-bottom: 1rem;
  }

  .stats-number {
    font-size: 2rem;
    font-weight: 700;
    margin-bottom: 0.5rem;
  }

  .admin-table {
    background: var(--color-white);
    border-radius: var(--radius-lg);
    overflow: hidden;
    box-shadow: var(--shadow-sm);
    border: var(--border-light);
  }

  .btn-admin {
    background: var(--color-primary);
    border: none;
    color: var(--color-white);
    border-radius: var(--radius-md);
    padding: 0.5rem 1rem;
    font-weight: 600;
    font-size: 0.875rem;
    transition: all 0.3s ease;
  }

  .btn-admin:hover {
    background: var(--color-primary-hover);
    color: var(--color-white);
    transform: translateY(-1px);
    box-shadow: var(--shadow-sm);
  }

  .btn-outline-admin {
    background: transparent;
    border: 1px solid var(--color-primary);
    color: var(--color-primary);
    border-radius: var(--radius-md);
    padding: 0.5rem 1rem;
    font-weight: 600;
    font-size: 0.875rem;
    transition: all 0.3s ease;
  }

  .btn-outline-admin:hover {
    background: var(--color-primary);
    color: var(--color-white);
  }

  .chart-container {
    background: var(--color-white);
    border-radius: var(--radius-lg);
    padding: 1.5rem;
    box-shadow: var(--shadow-sm);
    border: var(--border-light);
    height: 100%;
  }

  .recent-activity-container {
    max-height: 400px;
    overflow-y: auto;
  }

  .activity-item {
    padding: 0.75rem;
    border-bottom: 1px solid var(--color-gray-200);
    display: flex;
    align-items: flex-start;
    gap: 0.75rem;
  }

  .activity-item:last-child {
    border-bottom: none;
  }

  .activity-icon {
    width: 32px;
    height: 32px;
    border-radius: 50%;
    display: flex;
    align-items: center;
    justify-content: center;
    font-size: 0.875rem;
    flex-shrink: 0;
  }

  .activity-content {
    flex: 1;
    min-width: 0;
  }

  .activity-message {
    font-size: 0.875rem;
    margin-bottom: 0.25rem;
    word-wrap: break-word;
  }

  .activity-time {
    font-size: 0.75rem;
    color: var(--color-gray-500);
  }

  /* Responsive adjustments */
  @media (max-width: 768px) {
    .stats-card {
      padding: 1rem;
    }

    .stats-number {
      font-size: 1.5rem;
    }

    .stats-icon {
      width: 50px;
      height: 50px;
      font-size: 1.25rem;
    }

    .chart-container {
      padding: 1rem;
    }

    .activity-item {
      padding: 0.5rem;
    }

    .activity-message {
      font-size: 0.8rem;
    }

    .activity-time {
      font-size: 0.7rem;
    }

    .btn-admin,
    .btn-outline-admin {
      font-size: 0.8rem;
      padding: 0.75rem 0.5rem;
    }
  }

  @media (max-width: 576px) {
    .stats-card {
      text-align: center;
    }

    .stats-icon {
      margin: 0 auto 1rem auto;
    }

    .row.g-3 > .col-12 {
      margin-bottom: 0.5rem;
    }
  }
</style>

<script>

  
  let monthlyChart;

  // Check if Chart.js is loaded
  if (typeof Chart === 'undefined') {
    console.error('‚ùå Chart.js is not loaded!');
    // Load Chart.js dynamically
    const script = document.createElement('script');
    script.src = 'https://cdn.jsdelivr.net/npm/chart.js';
    script.onload = initializeApp;
    document.head.appendChild(script);
  } else {
    initializeApp();
  }

  function initializeApp() {
    console.log('‚úÖ Chart.js loaded, initializing app...');
    
    // Load initial data
    loadAdminStats();
    initializeChart();
    loadCategoryChartData();
    
    // Event listeners
    document.getElementById('categoryChartPeriod').addEventListener('change', function() {
      loadCategoryChartData();
    });
  }

  // Load admin statistics
  async function loadAdminStats() {
    try {
      const response = await fetch('/api/admin/stats?period=6');
      const data = await response.json();

      if (data.success) {
        const stats = data.stats;
        
        document.getElementById('totalUsers').textContent = stats.total_users.toLocaleString();
        document.getElementById('totalItems').textContent = stats.total_items.toLocaleString();
        document.getElementById('totalMatches').textContent = stats.total_matches.toLocaleString();
        document.getElementById('totalRevenue').textContent = '‚Ç±' + stats.total_revenue.toLocaleString();

        // Update recent activity
        if (data.recent_activity && data.recent_activity.length > 0) {
          displayRecentActivity(data.recent_activity);
        } else {
          displayRecentActivity([]);
        }
      } else {
        console.error('Failed to load stats:', data.error);
        showError('Failed to load statistics');
      }
    } catch (error) {
      console.error('Error loading stats:', error);
      showError('Error loading statistics');
    }
  }


  // Load chart data by category - SIMPLIFIED VERSION
  async function loadCategoryChartData() {
    try {
      const period = document.getElementById('categoryChartPeriod').value;
      console.log(`üìä Loading category chart for: ${period}`);
      
      const response = await fetch(`/api/admin/category-monthly?period=${period}`);
      const result = await response.json();
      
      console.log('üì¶ API Response:', result);
      
      if (result.success) {
        const chartData = result.chart_data;
        console.log('‚úÖ Data loaded:', {
          months: chartData.months,
          categories: chartData.categories,
          dataCount: chartData.data.length
        });
        
        // Directly update chart with the data
        updateChartSimple(chartData);
      } else {
        console.error('‚ùå API Error:', result.error);
        showError('Failed to load chart data');
      }
    } catch (error) {
      console.error('‚ùå Fetch Error:', error);
      showError('Error loading chart data');
    }
  }

  // Initialize chart
  function initializeChart() {
    const ctx = document.getElementById('monthlyChart').getContext('2d');
    monthlyChart = new Chart(ctx, {
      type: 'bar',
      data: {
        labels: [],
        datasets: []
      },
      options: {
        responsive: true,
        plugins: {
          legend: {
            display: true,
            position: 'top'
          },
          title: {
            display: false
          }
        },
        scales: {
          y: {
            beginAtZero: true,
            ticks: {
              stepSize: 1,
              callback: function(value) {
                return Number.isInteger(value) ? value : '';
              }
            },
            grid: {
              color: 'rgba(0, 0, 0, 0.1)'
            }
          },
          x: {
            grid: {
              display: false
            }
          }
        }
      }
    });
  }

  // SIMPLE and WORKING update chart function
  function updateChartSimple(chartData) {
    console.log('üé® Updating chart with:', chartData);
    
    // Clear previous data
    monthlyChart.data.labels = [];
    monthlyChart.data.datasets = [];
    
    // If no data, show message
    if (!chartData || !chartData.months || chartData.months.length === 0) {
      console.warn('‚ö†Ô∏è No data available');
      monthlyChart.data.labels = ['No Data'];
      monthlyChart.data.datasets = [{
        label: 'No Items',
        data: [0],
        backgroundColor: 'rgba(200, 200, 200, 0.6)'
      }];
      monthlyChart.update();
      return;
    }
    
    // Set months as labels
    monthlyChart.data.labels = chartData.months;
    
    // If no categories but we have months, show empty months
    if (!chartData.categories || chartData.categories.length === 0) {
      console.warn('‚ö†Ô∏è No categories found');
      monthlyChart.data.datasets = [{
        label: 'No Categories',
        data: new Array(chartData.months.length).fill(0),
        backgroundColor: 'rgba(200, 200, 200, 0.6)'
      }];
      monthlyChart.update();
      return;
    }
    
    // Color palette
    const colorPalette = [
      'rgba(30, 58, 138, 0.6)',    // Electronics - Dark Blue
      'rgba(59, 130, 246, 0.6)',   // Wallet - Blue
      'rgba(16, 185, 129, 0.6)',   // Keys - Green
      'rgba(245, 158, 11, 0.6)',   // Phone - Yellow
      'rgba(239, 68, 68, 0.6)',    // Laptop/Tablet - Red
      'rgba(139, 92, 246, 0.6)',   // Bag/Backpack - Purple
      'rgba(236, 72, 153, 0.6)',   // Clothing - Pink
      'rgba(20, 184, 166, 0.6)',   // Jewelry - Teal
      'rgba(249, 115, 22, 0.6)',   // Documents - Orange
      'rgba(132, 204, 22, 0.6)',   // Books - Light Green
      'rgba(99, 102, 241, 0.6)',   // Glasses - Indigo
      'rgba(139, 92, 246, 0.6)',   // Sports Equipment - Purple
      'rgba(236, 72, 153, 0.6)',   // Pet Items - Pink
      'rgba(156, 163, 175, 0.6)'   // Other - Gray
    ];
    
    // Create a map for quick data lookup
    const dataMap = {};
    chartData.data.forEach(item => {
      const key = `${item.month_name}-${item.category}`;
      dataMap[key] = item.total_items || 0;
    });
    
    // Create datasets for each category
    const datasets = chartData.categories.map((category, index) => {
      // Create data array for this category across all months
      const data = chartData.months.map(month => {
        const key = `${month}-${category}`;
        return dataMap[key] || 0;
      });
      
      console.log(`üìà "${category}":`, data);
      
      // Get color (cycle through palette)
      const color = colorPalette[index % colorPalette.length];
      
      return {
        label: category,
        data: data,
        backgroundColor: color,
        borderColor: color.replace('0.6', '1'),
        borderWidth: 1
      };
    });
    
    // Update chart
    monthlyChart.data.datasets = datasets;
    monthlyChart.update();
    
    console.log(`‚úÖ Chart updated with ${datasets.length} categories`);
  }

  // Display recent activity
  function displayRecentActivity(activities) {
    const container = document.getElementById('recentActivity');
    
    if (!activities || activities.length === 0) {
      container.innerHTML = `
        <div class="text-center py-4">
          <i class="fas fa-inbox fa-2x text-muted mb-3"></i>
          <p class="text-muted mb-0">No recent activity</p>
        </div>
      `;
      return;
    }

    const activityHtml = activities.map(activity => {
      const icon = getActivityIcon(activity.type);
      const timeAgo = getTimeAgo(activity.timestamp);
      
      return `
        <div class="activity-item">
          <div class="activity-icon ${icon.color}">
            <i class="${icon.icon}"></i>
          </div>
          <div class="activity-content">
            <div class="activity-message">${activity.message}</div>
            <div class="activity-time">${timeAgo}</div>
          </div>
        </div>
      `;
    }).join('');

    container.innerHTML = activityHtml;
  }

  // Get activity icon and color
  function getActivityIcon(type) {
    const icons = {
      'user_registered': { icon: 'fas fa-user-plus', color: 'bg-success bg-opacity-10 text-success' },
      'item_posted': { icon: 'fas fa-box', color: 'bg-primary bg-opacity-10 text-primary' },
      'match_created': { icon: 'fas fa-link', color: 'bg-info bg-opacity-10 text-info' },
      'item_resolved': { icon: 'fas fa-check-circle', color: 'bg-warning bg-opacity-10 text-warning' }
    };
    return icons[type] || { icon: 'fas fa-circle', color: 'bg-gray-200 text-gray-600' };
  }

 // Replace your existing getTimeAgo function with this fixed version
function getTimeAgo(timestamp) {
  const now = new Date();
  
  // Parse the timestamp - MySQL datetime format needs to be converted
  let time;
  if (typeof timestamp === 'string' && timestamp.includes(' ')) {
    // MySQL format: "2025-12-04 00:01:35" - replace space with T for ISO
    time = new Date(timestamp.replace(' ', 'T'));
  } else {
    time = new Date(timestamp);
  }
  
  // Check if date is valid
  if (isNaN(time.getTime())) {
    console.error('Invalid timestamp:', timestamp);
    return 'Unknown time';
  }
  
  // Calculate difference in milliseconds
  const diffMs = now - time;
  
  // If negative (future date), return "Just now"
  if (diffMs < 0) {
    return 'Just now';
  }
  
  // Calculate different time units
  const diffSeconds = Math.floor(diffMs / 1000);
  const diffMins = Math.floor(diffSeconds / 60);
  const diffHours = Math.floor(diffMins / 60);
  const diffDays = Math.floor(diffHours / 24);
  const diffWeeks = Math.floor(diffDays / 7);
  const diffMonths = Math.floor(diffDays / 30);
  const diffYears = Math.floor(diffDays / 365);
  
  // Return appropriate time string
  if (diffSeconds < 10) return 'Just now';
  if (diffSeconds < 60) return `${diffSeconds}s ago`;
  if (diffMins === 1) return '1m ago';
  if (diffMins < 60) return `${diffMins}m ago`;
  if (diffHours === 1) return '1h ago';
  if (diffHours < 24) return `${diffHours}h ago`;
  if (diffDays === 1) return '1d ago';
  if (diffDays < 7) return `${diffDays}d ago`;
  if (diffWeeks === 1) return '1w ago';
  if (diffWeeks < 4) return `${diffWeeks}w ago`;
  if (diffMonths === 1) return '1mo ago';
  if (diffMonths < 12) return `${diffMonths}mo ago`;
  if (diffYears === 1) return '1y ago';
  return `${diffYears}y ago`;
}

  
  // Error handling
  function showError(message) {
    console.error('‚ùå Error:', message);
    // Show toast notification
    const toast = document.createElement('div');
    toast.className = 'alert alert-danger alert-dismissible fade show position-fixed top-0 end-0 m-3';
    toast.style.zIndex = '9999';
    toast.innerHTML = `
      ${message}
      <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
    `;
    document.body.appendChild(toast);
    setTimeout(() => toast.remove(), 5000);
  }

  // Test function - run this in console to debug
  window.debugChart = async function() {
    console.log('üîç Debugging chart...');
    
    // Test API directly
    const periods = ['all_time', 'current_month', 'last_month'];
    
    for (const period of periods) {
      console.log(`\n=== Testing ${period} ===`);
      try {
        const response = await fetch(`/api/admin/category-monthly?period=${period}`);
        const data = await response.json();
        
        if (data.success) {
          console.log(`‚úÖ ${period}: Success`);
          console.log('üìÖ Months:', data.chart_data.months);
          console.log('üìã Categories:', data.chart_data.categories);
          console.log('üìä Data count:', data.chart_data.data.length);
          
          // Show first few data items
          console.log('üìù Sample data:', data.chart_data.data.slice(0, 3));
          
          // Check for Documents and Jewelry
          const hasDocs = data.chart_data.categories.includes('Documents');
          const hasJewelry = data.chart_data.categories.includes('Jewelry');
          console.log(`üìÑ Has Documents: ${hasDocs}`);
          console.log(`üíé Has Jewelry: ${hasJewelry}`);
          
          if (hasDocs) {
            const docsData = data.chart_data.data.filter(d => d.category === 'Documents');
            console.log('üìÑ Documents data:', docsData);
          }
        } else {
          console.log(`‚ùå ${period}:`, data.error);
        }
      } catch (error) {
        console.log(`‚ùå ${period} fetch error:`, error);
      }
    }
  };

  // Auto-refresh stats every 30 seconds
  setInterval(loadAdminStats, 30000);
</script>
{% endblock %}