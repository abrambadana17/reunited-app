{% extends "base.html" %}
{% block title %}Notifications - Reunited{% endblock %}

{% block content %}
<div class="dashboard-header mb-4">
  <h1 class="fw-bold mb-2">Notifications üîî</h1>
  <p class="mb-0 opacity-75">Stay updated with your item matches and activities.</p>
</div>

<div class="notifications-wrapper">
  <div class="notifications-stats-bar">
    <span class="stat-badge unread">
      {{ notifications | selectattr('is_read', 'equalto', False) | list | length }} New
    </span>
  </div>

  <div class="notifications-list">
    {% for n in notifications %}
      <div class="notification-card {% if not n.is_read %}unread{% endif %}" data-notification-id="{{ n.id }}">
        <!-- Notification Icon -->
        <div class="notification-icon-wrapper">
          {% if n.type == 'match_found' %}
            <div class="icon-circle match">üéØ</div>
          {% else %}
            <div class="icon-circle info">‚ÑπÔ∏è</div>
          {% endif %}
        </div>

        <!-- Notification Content -->
        <div class="notification-content">
          <div class="notification-header-row">
            <span class="notification-type">
              {% if n.type == 'match_found' %}
                Potential Match Found
              {% else %}
                Update
              {% endif %}
            </span>
            <span class="notification-time">
              {{ n.sent_at.strftime('%b %d, %I:%M %p') }}
            </span>
          </div>

          <div class="notification-message">
            {{ n.message | replace('\n', '<br>') | safe }}
          </div>

          {% if n.type == 'match_found' %}
            <div class="safety-notice">
              <div class="safety-icon">‚ö†Ô∏è</div>
              <div class="safety-text">
                <strong>Safety First:</strong> Always verify items before meeting. Ask for additional photos with today's date. Never pay fees upfront. Meet in public places.
              </div>
            </div>
          {% endif %}

          <!-- Action Buttons -->
          <div class="notification-actions">
            {% if not n.is_read %}
              <button class="btn-mark-read" onclick="markAsRead(event, {{ n.id }})">
                <span class="btn-icon">‚úì</span> Mark as Read
              </button>
            {% endif %}

            {% if n.type == 'match_found' and n.match_id %}
              <div class="claim-status" 
                   data-notification-id="{{ n.id }}" 
                   data-user-id="{{ session.user_id }}"
                   data-match-id="{{ n.match_id }}"
                   data-is-read="{{ 'True' if n.is_read else 'False' }}">
                <div class="claim-buttons">
                  <button class="btn-claim claim-btn" 
                          data-action="claimed" 
                          data-notification-id="{{ n.id }}"
                          style="display: none;">
                    <span class="btn-icon">‚úÖ</span> I Got My Item Back
                  </button>
                  <button class="btn-return claim-btn" 
                          data-action="returned" 
                          data-notification-id="{{ n.id }}"
                          style="display: none;">
                    <span class="btn-icon">ü§ù</span> I Returned The Item
                  </button>
                </div>
                <div class="claim-status-text" style="display: none;">
                  <small></small>
                </div>
              </div>
            {% endif %}
          </div>

          {% if not n.is_read %}
            <div class="unread-indicator"></div>
          {% endif %}
        </div>
      </div>
    {% else %}
      <div class="empty-state">
        <div class="empty-icon">üì≠</div>
        <h3>No notifications yet</h3>
        <p>When you report or find items, you'll see notifications here</p>
      </div>
    {% endfor %}
  </div>
</div>

<style>
:root {
  /* Unified Color Theme matching your profile.html */
  --primary: #4f46e5;         /* Indigo-600 */
  --primary-light: #818cf8;   /* Indigo-400 */
  --primary-dark: #3730a3;    /* Indigo-800 */
  --secondary: #10b981;       /* Emerald-500 */
  --secondary-light: #34d399; /* Emerald-400 */
  --secondary-dark: #059669;  /* Emerald-600 */
  --warning: #f59e0b;         /* Amber-500 */
  --warning-light: #fbbf24;   /* Amber-400 */
  --warning-dark: #d97706;    /* Amber-600 */
  --danger: #ef4444;          /* Red-500 */
  --danger-light: #f87171;    /* Red-400 */
  --danger-dark: #dc2626;     /* Red-600 */
  
  /* Neutral colors */
  --text-primary: #111827;    /* Gray-900 */
  --text-secondary: #6b7280;  /* Gray-500 */
  --text-light: #9ca3af;      /* Gray-400 */
  --bg-card: #ffffff;
  --bg-light: #f9fafb;        /* Gray-50 */
  --bg-hover: #f3f4f6;        /* Gray-100 */
  --border-color: #e5e7eb;    /* Gray-200 */
  --border-light: #f3f4f6;    /* Gray-100 */
  
  /* Shadows */
  --shadow-sm: 0 1px 2px 0 rgba(0, 0, 0, 0.05);
  --shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1), 0 2px 4px -1px rgba(0, 0, 0, 0.06);
  --shadow-md: 0 10px 15px -3px rgba(0, 0, 0, 0.1), 0 4px 6px -2px rgba(0, 0, 0, 0.05);
  --shadow-lg: 0 20px 25px -5px rgba(0, 0, 0, 0.1), 0 10px 10px -5px rgba(0, 0, 0, 0.04);
}

/* Match profile.html spacing and structure */
.notifications-wrapper {
  max-width: 800px;
  width: 100%;
  margin-left: auto;
  margin-right: auto;
  margin-bottom: 2rem;
}

.notifications-stats-bar {
  background: var(--bg-card);
  border: 1px solid var(--border-color);
  border-radius: 12px;
  box-shadow: var(--shadow);
  padding: 1rem 1.5rem;
  margin-bottom: 1rem;
  display: flex;
  justify-content: flex-end;
}

.stat-badge {
  background: linear-gradient(135deg, var(--primary) 0%, var(--primary-dark) 100%);
  color: white;
  padding: 8px 16px;
  border-radius: 8px;
  font-weight: 600;
  font-size: 0.875rem;
  box-shadow: var(--shadow-sm);
}

.notifications-list {
  display: flex;
  flex-direction: column;
  gap: 1rem;
}

.notification-card {
  background: var(--bg-card);
  border: 1px solid var(--border-color);
  border-radius: 12px;
  box-shadow: var(--shadow);
  padding: 1.5rem;
  display: flex;
  gap: 1rem;
  position: relative;
  transition: all 0.3s ease;
}

.notification-card:hover {
  box-shadow: var(--shadow-md);
  transform: translateY(-2px);
  border-color: var(--primary-light);
}

.notification-card.unread {
  background: linear-gradient(to right, rgba(245, 158, 11, 0.05) 0%, var(--bg-card) 5%);
  border-left: 4px solid var(--warning);
}

.notification-icon-wrapper {
  flex-shrink: 0;
}

.icon-circle {
  width: 60px;
  height: 60px;
  border-radius: 50%;
  display: flex;
  align-items: center;
  justify-content: center;
  font-size: 24px;
  box-shadow: var(--shadow-md);
}

.icon-circle.match {
  background: linear-gradient(135deg, var(--primary) 0%, var(--primary-dark) 100%);
  color: white;
}

.icon-circle.info {
  background: linear-gradient(135deg, var(--secondary) 0%, var(--secondary-dark) 100%);
  color: white;
}

.notification-content {
  flex: 1;
  min-width: 0;
}

.notification-header-row {
  display: flex;
  justify-content: space-between;
  align-items: center;
  margin-bottom: 0.75rem;
  gap: 1rem;
  flex-wrap: wrap;
}

.notification-type {
  font-weight: 600;
  color: var(--text-primary);
  font-size: 1rem;
}

.notification-time {
  color: var(--text-secondary);
  font-size: 0.875rem;
  white-space: nowrap;
}

.notification-message {
  color: var(--text-primary);
  line-height: 1.6;
  margin-bottom: 1rem;
  white-space: pre-line;
  font-size: 0.9rem;
}

.safety-notice {
  background: rgba(245, 158, 11, 0.1);
  border-left: 3px solid var(--warning);
  padding: 0.75rem;
  border-radius: 8px;
  margin: 1rem 0;
  display: flex;
  gap: 0.75rem;
}

.safety-icon {
  font-size: 18px;
  flex-shrink: 0;
  color: var(--warning-dark);
}

.safety-text {
  font-size: 0.85rem;
  color: var(--warning-dark);
  line-height: 1.5;
}

.notification-actions {
  display: flex;
  flex-wrap: wrap;
  gap: 0.75rem;
  margin-top: 1rem;
}

.btn-mark-read,
.btn-claim,
.btn-return {
  padding: 10px 20px;
  border-radius: 8px;
  border: none;
  font-weight: 500;
  cursor: pointer;
  display: flex;
  align-items: center;
  gap: 8px;
  transition: all 0.3s ease;
  font-size: 0.875rem;
}

.btn-mark-read {
  background: var(--bg-card);
  color: var(--text-primary);
  border: 1px solid var(--border-color);
}

.btn-mark-read:hover {
  background: var(--bg-hover);
  border-color: var(--text-light);
}

.btn-claim {
  background: linear-gradient(135deg, var(--secondary) 0%, var(--secondary-dark) 100%);
  color: white;
  box-shadow: var(--shadow-sm);
}

.btn-claim:hover {
  transform: translateY(-2px);
  box-shadow: var(--shadow-md);
}

.btn-return {
  background: linear-gradient(135deg, var(--primary) 0%, var(--primary-dark) 100%);
  color: white;
  box-shadow: var(--shadow-sm);
}

.btn-return:hover {
  transform: translateY(-2px);
  box-shadow: var(--shadow-md);
}

.btn-icon {
  font-size: 1rem;
}

.claim-buttons {
  display: flex;
  flex-wrap: wrap;
  gap: 0.75rem;
}

.claim-status-text {
  margin-top: 0.75rem;
  padding: 0.75rem;
  background: rgba(16, 185, 129, 0.1);
  border-radius: 8px;
  border-left: 3px solid var(--secondary);
}

.claim-status-text small {
  color: var(--secondary-dark);
  font-weight: 600;
  font-size: 0.85rem;
}

.unread-indicator {
  position: absolute;
  top: 1.5rem;
  right: 1.5rem;
  width: 10px;
  height: 10px;
  background: var(--warning);
  border-radius: 50%;
  box-shadow: 0 0 0 0 rgba(245, 158, 11, 0.7);
  animation: pulse 2s infinite;
}

@keyframes pulse {
  0% {
    transform: scale(0.95);
    box-shadow: 0 0 0 0 rgba(245, 158, 11, 0.7);
  }
  70% {
    transform: scale(1);
    box-shadow: 0 0 0 10px rgba(245, 158, 11, 0);
  }
  100% {
    transform: scale(0.95);
    box-shadow: 0 0 0 0 rgba(245, 158, 11, 0);
  }
}

.empty-state {
  text-align: center;
  padding: 3rem 1.5rem;
  background: var(--bg-card);
  border: 1px solid var(--border-color);
  border-radius: 12px;
  box-shadow: var(--shadow);
}

.empty-icon {
  font-size: 4rem;
  margin-bottom: 1rem;
  color: var(--text-light);
}

.empty-state h3 {
  color: var(--text-primary);
  margin-bottom: 0.5rem;
  font-size: 1.25rem;
  font-weight: 600;
}

.empty-state p {
  color: var(--text-secondary);
  font-size: 0.9rem;
  max-width: 400px;
  margin: 0 auto;
}

/* Mobile Responsive - Match profile.html breakpoints */
@media (max-width: 768px) {
  .notifications-stats-bar {
    padding: 0.75rem 1rem;
  }

  .notification-card {
    padding: 1rem;
    flex-direction: column;
  }

  .notification-icon-wrapper {
    align-self: flex-start;
  }

  .icon-circle {
    width: 50px;
    height: 50px;
    font-size: 20px;
  }

  .notification-header-row {
    flex-direction: column;
    align-items: flex-start;
  }

  .notification-actions {
    flex-direction: column;
  }

  .btn-mark-read,
  .btn-claim,
  .btn-return {
    width: 100%;
    justify-content: center;
    min-height: 44px;
  }

  .claim-buttons {
    width: 100%;
  }
}

@media (max-width: 576px) {
  .dashboard-header h1 {
    font-size: 1.5rem;
  }

  .dashboard-header p {
    font-size: 0.9rem;
  }

  .notification-message {
    font-size: 0.85rem;
  }

  .notification-type {
    font-size: 0.9rem;
  }

  .safety-notice {
    flex-direction: column;
  }

  .stat-badge {
    font-size: 0.8rem;
    padding: 6px 12px;
  }
}

/* Responsive grid adjustment for larger screens - match profile.html */
@media (min-width: 768px) {
  .notifications-stats-bar {
    padding: 1rem 2rem;
  }

  .notification-card {
    padding: 2rem;
  }

  .icon-circle {
    width: 60px;
    height: 60px;
    font-size: 24px;
  }

  .notification-type {
    font-size: 1.1rem;
  }

  .notification-message {
    font-size: 1rem;
  }

  .btn-mark-read,
  .btn-claim,
  .btn-return {
    padding: 12px 24px;
    font-size: 0.9rem;
  }
}
</style>

<script>
function markAsRead(event, notificationId) {
    event.preventDefault();
    
    fetch(`/notifications/read/${notificationId}`)
        .then(response => {
            if (response.ok) {
                const card = event.target.closest('.notification-card');
                card.classList.remove('unread');
                
                const indicator = card.querySelector('.unread-indicator');
                if (indicator) indicator.remove();
                
                event.target.style.display = 'none';
                
                const statusDiv = card.querySelector('.claim-status');
                if (statusDiv) {
                    statusDiv.dataset.isRead = 'True';
                    checkClaimStatus(statusDiv);
                }
                
                // Update header count
                const badge = document.querySelector('.stat-badge.unread');
                if (badge) {
                    const currentCount = parseInt(badge.textContent);
                    const newCount = Math.max(0, currentCount - 1);
                    badge.textContent = `${newCount} New`;
                }
                
                showToast('Notification marked as read', 'success');
            }
        })
        .catch(error => {
            console.error('Error marking as read:', error);
            showToast('Error marking notification as read', 'error');
        });
}

function checkClaimStatus(statusDiv) {
    const notificationId = statusDiv.dataset.notificationId;
    const currentUserId = parseInt(statusDiv.dataset.userId);
    const matchId = statusDiv.dataset.matchId;
    
    Promise.all([
        fetch(`/api/match-details/${matchId}`).then(r => r.json()),
        fetch(`/api/claim-status/${notificationId}`).then(r => r.json())
    ])
    .then(([matchData, claimData]) => {
        if (matchData.success && claimData.success) {
            const claimedBtn = statusDiv.querySelector('[data-action="claimed"]');
            const returnedBtn = statusDiv.querySelector('[data-action="returned"]');
            
            const isLostOwner = currentUserId === matchData.match.lost_user_id;
            const isFoundOwner = currentUserId === matchData.match.found_user_id;
            
            if (isLostOwner && claimedBtn) {
                claimedBtn.dataset.itemId = matchData.match.lost_item_id;
            }
            if (isFoundOwner && returnedBtn) {
                returnedBtn.dataset.itemId = matchData.match.found_item_id;
            }
            
            updateClaimUI(statusDiv, claimData.claim_status, currentUserId);
        }
    })
    .catch(error => {
        console.error('Error fetching data:', error);
    });
}

document.addEventListener('DOMContentLoaded', function() {
    const claimStatuses = document.querySelectorAll('.claim-status');
    
    claimStatuses.forEach(function(statusDiv) {
        checkClaimStatus(statusDiv);
    });
    
    document.addEventListener('click', function(e) {
        if (e.target.classList.contains('claim-btn') || e.target.closest('.claim-btn')) {
            e.preventDefault();
            
            const button = e.target.classList.contains('claim-btn') ? e.target : e.target.closest('.claim-btn');
            const action = button.dataset.action;
            const itemId = button.dataset.itemId;
            const notificationId = button.dataset.notificationId;
            
            if (!itemId) {
                showToast('Error: Item ID not found. Please refresh the page.', 'error');
                return;
            }
            
            button.disabled = true;
            const originalHTML = button.innerHTML;
            button.innerHTML = '<span class="btn-icon">‚è≥</span> Processing...';
            
            fetch('/api/claim', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                },
                body: JSON.stringify({
                    notification_id: notificationId,
                    item_id: itemId,
                    action_type: action
                })
            })
            .then(response => response.json())
            .then(data => {
                if (data.success) {
                    button.style.display = 'none';
                    
                    const card = button.closest('.notification-card');
                    card.classList.remove('unread');
                    
                    const indicator = card.querySelector('.unread-indicator');
                    if (indicator) indicator.remove();
                    
                    const markReadBtn = card.querySelector('.btn-mark-read');
                    if (markReadBtn) markReadBtn.style.display = 'none';
                    
                    const statusDiv = button.closest('.claim-status');
                    statusDiv.dataset.isRead = 'True';
                    
                    showToast(data.message, 'success');
                    
                    if (data.both_completed) {
                        showToast('üéâ Both parties have confirmed! The exchange is complete.', 'success');
                        
                        const statusText = statusDiv.querySelector('.claim-status-text');
                        const statusTextContent = statusText.querySelector('small');
                        statusText.style.display = 'block';
                        statusTextContent.textContent = '‚úÖ Exchange completed! Match resolved.';
                    }
                } else {
                    showToast(data.errors.join(', '), 'error');
                    button.disabled = false;
                    button.innerHTML = originalHTML;
                }
            })
            .catch(error => {
                console.error('Error:', error);
                showToast('An error occurred. Please try again.', 'error');
                button.disabled = false;
                button.innerHTML = originalHTML;
            });
        }
    });
});

function updateClaimUI(statusDiv, claimStatus, currentUserId) {
    const claimedBtn = statusDiv.querySelector('[data-action="claimed"]');
    const returnedBtn = statusDiv.querySelector('[data-action="returned"]');
    const statusText = statusDiv.querySelector('.claim-status-text');
    const statusTextContent = statusText.querySelector('small');
    
    if (claimedBtn) claimedBtn.style.display = 'none';
    if (returnedBtn) returnedBtn.style.display = 'none';
    statusText.style.display = 'none';
    
    const userClaimed = claimStatus.claimed && claimStatus.claimed.user_id === currentUserId;
    const userReturned = claimStatus.returned && claimStatus.returned.user_id === currentUserId;
    
    if (claimStatus.both_completed) {
        statusText.style.display = 'block';
        statusTextContent.textContent = '‚úÖ Exchange completed! Match resolved.';
        
    } else if (userClaimed || userReturned) {
        statusText.style.display = 'block';
        if (userClaimed) {
            statusTextContent.textContent = '‚úì You confirmed you received your item back.';
        } else {
            statusTextContent.textContent = '‚úì You confirmed you returned the item.';
        }
        
    } else {
        if (claimedBtn && claimedBtn.dataset.itemId) {
            claimedBtn.style.display = 'inline-flex';
        }
        if (returnedBtn && returnedBtn.dataset.itemId) {
            returnedBtn.style.display = 'inline-flex';
        }
    }
}

function showToast(message, type) {
    const toast = document.createElement('div');
    toast.className = `toast-notification ${type}`;
    toast.style.cssText = `
        position: fixed;
        top: 20px;
        right: 20px;
        background: ${type === 'error' ? 'var(--danger)' : type === 'success' ? 'var(--secondary)' : 'var(--primary)'};
        color: white;
        padding: 1rem 1.5rem;
        border-radius: 8px;
        box-shadow: var(--shadow-lg);
        z-index: 9999;
        animation: slideIn 0.3s ease;
        max-width: 400px;
        font-size: 0.9rem;
        border: 1px solid ${type === 'error' ? 'var(--danger-dark)' : type === 'success' ? 'var(--secondary-dark)' : 'var(--primary-dark)'};
    `;
    toast.textContent = message;
    
    document.body.appendChild(toast);
    
    setTimeout(() => {
        toast.style.animation = 'slideOut 0.3s ease';
        setTimeout(() => {
            if (toast.parentNode) {
                toast.parentNode.removeChild(toast);
            }
        }, 300);
    }, 5000);
}
</script>

<style>
@keyframes slideIn {
  from {
    transform: translateX(400px);
    opacity: 0;
  }
  to {
    transform: translateX(0);
    opacity: 1;
  }
}

@keyframes slideOut {
  from {
    transform: translateX(0);
    opacity: 1;
  }
  to {
    transform: translateX(400px);
    opacity: 0;
  }
}
</style>
{% endblock %}